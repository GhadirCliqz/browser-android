System.register('yt-downloader/main', [], function (_export) {
  'use strict';

  /*
  This provides the downloadable link for youtube videos.
  Most of the regex and concepts have been picked up from https://github.com/gantt/downloadyoutube.
  
  The idea would be to move the patterns and other config to a web-service so that if patterns change we can easily update the changes.
  */

  var TITLE_REGEX, FORMAT_LABEL, FORMAT_TYPE, FORMAT_ORDER, FORMAT_RULE, SHOW_DASH_FORMATS;

  function findMatch(text, regexp) {
    var matches = text.match(regexp);
    return matches ? matches[1] : null;
  }

  function findVideoLinks(youtubePageContent) {
    osAPI.notifyYoutubeVideoUrls(get_links(youtubePageContent));
  }

  function getSeparators(videoFormats) {
    var sep1 = undefined,
        sep2 = undefined,
        sep3 = undefined;
    if (videoFormats.indexOf(',') > -1) {
      sep1 = ',';
      sep2 = videoFormats.indexOf('&') > -1 ? '&' : '\\u0026';
      sep3 = '=';
    } else {
      sep1 = '%2C';
      sep2 = '%26';
      sep3 = '%3D';
    }
    return { sep1: sep1, sep2: sep2, sep3: sep3 };
  }

  function get_links(bodyContent) {
    var videoID = null,
        videoFormats = undefined,
        videoAdaptFormats = undefined,
        videoManifestURL = undefined;

    if (bodyContent !== null) {
      videoID = findMatch(bodyContent, /\"video_id\":\s*\"([^\"]+)\"/);
      videoFormats = findMatch(bodyContent, /\"url_encoded_fmt_stream_map\":\s*\"([^\"]+)\"/);
      videoAdaptFormats = findMatch(bodyContent, /\"adaptive_fmts\":\s*\"([^\"]+)\"/);
      videoManifestURL = findMatch(bodyContent, /\"dashmpd\":\s*\"([^\"]+)\"/);
    }

    var videoTitle = findMatch(bodyContent, TITLE_REGEX);
    videoTitle = videoTitle ? videoTitle : 'Youtube Video';

    // parse the formats map

    var _getSeparators = getSeparators(videoFormats);

    var sep1 = _getSeparators.sep1;
    var sep2 = _getSeparators.sep2;
    var sep3 = _getSeparators.sep3;

    var videoURL = [];
    var videoSignature = [];
    if (videoAdaptFormats) {
      videoFormats = videoFormats + sep1 + videoAdaptFormats;
    }

    var videoFormatsGroup = videoFormats.split(sep1);
    for (var i = 0; i < videoFormatsGroup.length; i++) {
      var videoFormatsElem = videoFormatsGroup[i].split(sep2);
      var videoFormatsPair = [];
      for (var j = 0; j < videoFormatsElem.length; j++) {
        var pair = videoFormatsElem[j].split(sep3);
        if (pair.length === 2) {
          videoFormatsPair[pair[0]] = pair[1];
        }
      }
      if (videoFormatsPair['url'] === null) {
        continue;
      }
      var url = unescape(unescape(videoFormatsPair['url'])).replace(/\\\//g, '/').replace(/\\u0026/g, '&');
      if (videoFormatsPair['itag'] === null) {
        continue;
      }
      var itag = videoFormatsPair['itag'];
      var sig = videoFormatsPair['sig'] || videoFormatsPair['signature'];
      if (sig) {
        url = url + '&signature=' + sig;
        videoSignature[itag] = null;
      } else if (videoFormatsPair['s']) {
        url = url + '&signature=' + videoFormatsPair['s'];
        videoSignature[itag] = videoFormatsPair['s'];
      }
      if (url.toLowerCase().indexOf('ratebypass') === -1) {
        // speed up download for dash
        url = url + '&ratebypass = yes';
      }
      if (url.toLowerCase().indexOf('http') === 0) {
        // validate URL
        videoURL[itag] = url + '&title=' + videoTitle;
      }
    }

    var showFormat = [];
    for (var category in FORMAT_RULE) {
      var rule = FORMAT_RULE[category];
      for (var index in FORMAT_TYPE) {
        if (FORMAT_TYPE[index] === category) {
          showFormat[index] = rule === 'all';
        }
      }
      if (rule === 'max') {
        for (var i = FORMAT_ORDER.length - 1; i >= 0; i--) {
          var format = FORMAT_ORDER[i];
          if (FORMAT_TYPE[format] === category && videoURL[format] !== undefined) {
            showFormat[format] = true;
            break;
          }
        }
      }
    }

    var downloadCodeList = [];
    for (var i = 0; i < FORMAT_ORDER.length; i++) {
      var format = FORMAT_ORDER[i];
      if (format === '37' && videoURL[format] === undefined) {
        // hack for dash 1080p
        if (videoURL['137']) {
          format = '137';
        }
        showFormat[format] = showFormat['37'];
      } else if (format === '38' && videoURL[format] === undefined) {
        // hack for dash 4K
        if (videoURL['138'] && !videoURL['266']) {
          format = '138';
        }
        showFormat[format] = showFormat['38'];
      }
      if (!SHOW_DASH_FORMATS && format.length > 2) {
        continue;
      }
      if (videoURL[format] !== undefined && FORMAT_LABEL[format] !== undefined && showFormat[format]) {
        downloadCodeList.push({ url: encodeURIComponent(videoURL[format]), sig: videoSignature[format], format: format, label: FORMAT_LABEL[format] });
        console.log('DYVAM - Info: itag' + format + ' url:' + videoURL[format]);
      }
    }

    if (downloadCodeList.length === 0) {
      console.log('No download URL found. Probably YouTube uses encrypted streams.');
    }
    return downloadCodeList;
  }

  return {
    setters: [],
    execute: function () {
      TITLE_REGEX = /<meta\s+name="title"\s+content="([^"]*)">/;
      FORMAT_LABEL = { '5': 'FLV 240p', '18': 'MP4 360p', '22': 'MP4 720p', '34': 'FLV 360p', '35': 'FLV 480p', '37': 'MP4 1080p', '38': 'MP4 2160p', '43': 'WebM 360p', '44': 'WebM 480p', '45': 'WebM 720p', '46': 'WebM 1080p', '135': 'MP4 480p - no audio', '137': 'MP4 1080p - no audio', '138': 'MP4 2160p - no audio', '139': 'M4A 48kbps - audio', '140': 'M4A 128kbps - audio', '141': 'M4A 256kbps - audio', '264': 'MP4 1440p - no audio', '266': 'MP4 2160p - no audio', '298': 'MP4 720p60 - no audio', '299': 'MP4 1080p60 - no audio' };
      FORMAT_TYPE = { '5': 'flv', '18': 'mp4', '22': 'mp4', '34': 'flv', '35': 'flv', '37': 'mp4', '38': 'mp4', '43': 'webm', '44': 'webm', '45': 'webm', '46': 'webm', '135': 'mp4', '137': 'mp4', '138': 'mp4', '139': 'm4a', '140': 'm4a', '141': 'm4a', '264': 'mp4', '266': 'mp4', '298': 'mp4', '299': 'mp4' };
      FORMAT_ORDER = ['5', '18', '34', '43', '35', '135', '44', '22', '298', '45', '37', '299', '46', '264', '38', '266', '139', '140', '141'];
      FORMAT_RULE = { 'flv': 'none', 'mp4': 'all', 'webm': 'max', 'm4a': 'max' };

      // all = display all versions, max = only highest quality version, none = no version
      // the default settings show all MP4 videos, the highest quality FLV and no WebM
      SHOW_DASH_FORMATS = false;

      _export('findVideoLinks', findVideoLinks);
    }
  };
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInl0LWRvd25sb2FkZXIvbWFpbi5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsY0FBWSxDQUFDOzs7Ozs7Ozs7TUFVUCxXQUFXLEVBQ1gsWUFBWSxFQUNaLFdBQVcsRUFDWCxZQUFZLEVBQ1osV0FBVyxFQUdYLGlCQUFpQjs7QUFFdkIsV0FBUyxTQUFTLENBQUMsSUFBSSxFQUFFLE1BQU0sRUFBRTtBQUM3QixRQUFNLE9BQU8sR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxDQUFDO0FBQ25DLFdBQU8sQUFBQyxPQUFPLEdBQUksT0FBTyxDQUFDLENBQUMsQ0FBQyxHQUFHLElBQUksQ0FBQztHQUN4Qzs7QUFFRCxXQUFTLGNBQWMsQ0FBQyxrQkFBa0IsRUFBRTtBQUMxQyxTQUFLLENBQUMsc0JBQXNCLENBQUMsU0FBUyxDQUFDLGtCQUFrQixDQUFDLENBQUMsQ0FBQztHQUM3RDs7QUFFRCxXQUFTLGFBQWEsQ0FBQyxZQUFZLEVBQUU7QUFDbkMsUUFBSSxJQUFJLFlBQUE7UUFBRSxJQUFJLFlBQUE7UUFBRSxJQUFJLFlBQUEsQ0FBQztBQUNyQixRQUFJLFlBQVksQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxDQUFDLEVBQUU7QUFDbEMsVUFBSSxHQUFHLEdBQUcsQ0FBQztBQUNYLFVBQUksR0FBRyxBQUFDLFlBQVksQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxDQUFDLEdBQUksR0FBRyxHQUFHLFNBQVMsQ0FBQztBQUMxRCxVQUFJLEdBQUcsR0FBRyxDQUFDO0tBQ1osTUFBTTtBQUNMLFVBQUksR0FBRyxLQUFLLENBQUM7QUFDYixVQUFJLEdBQUcsS0FBSyxDQUFDO0FBQ2IsVUFBSSxHQUFHLEtBQUssQ0FBQztLQUNkO0FBQ0QsV0FBTyxFQUFFLElBQUksRUFBSixJQUFJLEVBQUUsSUFBSSxFQUFKLElBQUksRUFBRSxJQUFJLEVBQUosSUFBSSxFQUFFLENBQUM7R0FDN0I7O0FBRUQsV0FBUyxTQUFTLENBQUMsV0FBVyxFQUFFO0FBQzlCLFFBQUksT0FBTyxHQUFHLElBQUk7UUFDZCxZQUFZLFlBQUE7UUFDWixpQkFBaUIsWUFBQTtRQUNqQixnQkFBZ0IsWUFBQSxDQUFDOztBQUVyQixRQUFJLFdBQVcsS0FBSyxJQUFJLEVBQUU7QUFDeEIsYUFBTyxHQUFHLFNBQVMsQ0FBQyxXQUFXLEVBQUUsOEJBQThCLENBQUMsQ0FBQztBQUNqRSxrQkFBWSxHQUFHLFNBQVMsQ0FBQyxXQUFXLEVBQUUsZ0RBQWdELENBQUMsQ0FBQztBQUN4Rix1QkFBaUIsR0FBRyxTQUFTLENBQUMsV0FBVyxFQUFFLG1DQUFtQyxDQUFDLENBQUM7QUFDaEYsc0JBQWdCLEdBQUcsU0FBUyxDQUFDLFdBQVcsRUFBRSw2QkFBNkIsQ0FBQyxDQUFDO0tBQzFFOztBQUVELFFBQUksVUFBVSxHQUFHLFNBQVMsQ0FBQyxXQUFXLEVBQUUsV0FBVyxDQUFDLENBQUM7QUFDckQsY0FBVSxHQUFHLEFBQUMsVUFBVSxHQUFJLFVBQVUsR0FBRyxlQUFlLENBQUM7Ozs7eUJBRzVCLGFBQWEsQ0FBQyxZQUFZLENBQUM7O1FBQWhELElBQUksa0JBQUosSUFBSTtRQUFFLElBQUksa0JBQUosSUFBSTtRQUFFLElBQUksa0JBQUosSUFBSTs7QUFHeEIsUUFBSSxRQUFRLEdBQUcsRUFBRSxDQUFDO0FBQ2xCLFFBQUksY0FBYyxHQUFHLEVBQUUsQ0FBQztBQUN4QixRQUFJLGlCQUFpQixFQUFFO0FBQ3JCLGtCQUFZLEdBQUcsWUFBWSxHQUFHLElBQUksR0FBRyxpQkFBaUIsQ0FBQztLQUN4RDs7QUFFRCxRQUFJLGlCQUFpQixHQUFHLFlBQVksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUM7QUFDakQsU0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLGlCQUFpQixDQUFDLE1BQU0sRUFBRSxDQUFDLEVBQUUsRUFBRTtBQUNqRCxVQUFJLGdCQUFnQixHQUFHLGlCQUFpQixDQUFDLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQztBQUN4RCxVQUFJLGdCQUFnQixHQUFHLEVBQUUsQ0FBQztBQUMxQixXQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUMsZ0JBQWdCLENBQUMsTUFBTSxFQUFFLENBQUMsRUFBRSxFQUFFO0FBQzlDLFlBQUksSUFBSSxHQUFHLGdCQUFnQixDQUFDLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQztBQUMzQyxZQUFJLElBQUksQ0FBQyxNQUFNLEtBQUssQ0FBQyxFQUFFO0FBQ3JCLDBCQUFnQixDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxHQUFHLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztTQUNyQztPQUNGO0FBQ0QsVUFBSSxnQkFBZ0IsQ0FBQyxLQUFLLENBQUMsS0FBSyxJQUFJLEVBQUU7QUFDcEMsaUJBQVM7T0FDVjtBQUNELFVBQUksR0FBRyxHQUFHLFFBQVEsQ0FBQyxRQUFRLENBQUMsZ0JBQWdCLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxPQUFPLEVBQUMsR0FBRyxDQUFDLENBQUMsT0FBTyxDQUFDLFVBQVUsRUFBQyxHQUFHLENBQUMsQ0FBQztBQUNuRyxVQUFJLGdCQUFnQixDQUFDLE1BQU0sQ0FBQyxLQUFLLElBQUksRUFBRTtBQUNyQyxpQkFBUztPQUNWO0FBQ0QsVUFBSSxJQUFJLEdBQUcsZ0JBQWdCLENBQUMsTUFBTSxDQUFDLENBQUM7QUFDcEMsVUFBSSxHQUFHLEdBQUcsZ0JBQWdCLENBQUMsS0FBSyxDQUFDLElBQUUsZ0JBQWdCLENBQUMsV0FBVyxDQUFDLENBQUM7QUFDakUsVUFBSSxHQUFHLEVBQUU7QUFDUCxXQUFHLEdBQUcsR0FBRyxHQUFDLGFBQWEsR0FBRyxHQUFHLENBQUM7QUFDOUIsc0JBQWMsQ0FBQyxJQUFJLENBQUMsR0FBRyxJQUFJLENBQUM7T0FDN0IsTUFDSSxJQUFJLGdCQUFnQixDQUFDLEdBQUcsQ0FBQyxFQUFFO0FBQzlCLFdBQUcsR0FBRyxHQUFHLEdBQUMsYUFBYSxHQUFHLGdCQUFnQixDQUFDLEdBQUcsQ0FBQyxDQUFDO0FBQ2hELHNCQUFjLENBQUMsSUFBSSxDQUFDLEdBQUcsZ0JBQWdCLENBQUMsR0FBRyxDQUFDLENBQUM7T0FDOUM7QUFDRCxVQUFJLEdBQUcsQ0FBQyxXQUFXLEVBQUUsQ0FBQyxPQUFPLENBQUMsWUFBWSxDQUFDLEtBQUssQ0FBQyxDQUFDLEVBQUU7O0FBQ2xELFdBQUcsR0FBRyxHQUFHLEdBQUMsbUJBQW1CLENBQUM7T0FDL0I7QUFDRCxVQUFJLEdBQUcsQ0FBQyxXQUFXLEVBQUUsQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxFQUFFOztBQUMzQyxnQkFBUSxDQUFDLElBQUksQ0FBQyxHQUFHLEdBQUcsR0FBRyxTQUFTLEdBQUcsVUFBVSxDQUFDO09BQy9DO0tBQ0Y7O0FBRUQsUUFBSSxVQUFVLEdBQUcsRUFBRSxDQUFDO0FBQ3BCLFNBQUssSUFBSSxRQUFRLElBQUksV0FBVyxFQUFFO0FBQ2hDLFVBQU0sSUFBSSxHQUFHLFdBQVcsQ0FBQyxRQUFRLENBQUMsQ0FBQztBQUNuQyxXQUFLLElBQUksS0FBSyxJQUFJLFdBQVcsRUFBQztBQUM1QixZQUFJLFdBQVcsQ0FBQyxLQUFLLENBQUMsS0FBSyxRQUFRLEVBQUU7QUFDbkMsb0JBQVUsQ0FBQyxLQUFLLENBQUMsR0FBSSxJQUFJLEtBQUssS0FBSyxBQUFDLENBQUM7U0FDdEM7T0FDRjtBQUNELFVBQUksSUFBSSxLQUFLLEtBQUssRUFBRTtBQUNsQixhQUFLLElBQUksQ0FBQyxHQUFHLFlBQVksQ0FBQyxNQUFNLEdBQUMsQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxFQUFFLEVBQUU7QUFDL0MsY0FBSSxNQUFNLEdBQUcsWUFBWSxDQUFDLENBQUMsQ0FBQyxDQUFDO0FBQzdCLGNBQUksV0FBVyxDQUFDLE1BQU0sQ0FBQyxLQUFLLFFBQVEsSUFBSSxRQUFRLENBQUMsTUFBTSxDQUFDLEtBQUssU0FBUyxFQUFFO0FBQ3RFLHNCQUFVLENBQUMsTUFBTSxDQUFDLEdBQUcsSUFBSSxDQUFDO0FBQzFCLGtCQUFNO1dBQ1A7U0FDRjtPQUNGO0tBQ0Y7O0FBRUQsUUFBSSxnQkFBZ0IsR0FBRyxFQUFFLENBQUM7QUFDMUIsU0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLFlBQVksQ0FBQyxNQUFNLEVBQUUsQ0FBQyxFQUFFLEVBQUU7QUFDNUMsVUFBSSxNQUFNLEdBQUcsWUFBWSxDQUFDLENBQUMsQ0FBQyxDQUFDO0FBQzdCLFVBQUksTUFBTSxLQUFLLElBQUksSUFBSSxRQUFRLENBQUMsTUFBTSxDQUFDLEtBQUssU0FBUyxFQUFFOztBQUNyRCxZQUFJLFFBQVEsQ0FBQyxLQUFLLENBQUMsRUFBRTtBQUNwQixnQkFBTSxHQUFHLEtBQUssQ0FBQztTQUNmO0FBQ0Qsa0JBQVUsQ0FBQyxNQUFNLENBQUMsR0FBRyxVQUFVLENBQUMsSUFBSSxDQUFDLENBQUM7T0FDdkMsTUFBTSxJQUFJLE1BQU0sS0FBSyxJQUFJLElBQUksUUFBUSxDQUFDLE1BQU0sQ0FBQyxLQUFLLFNBQVMsRUFBRTs7QUFDNUQsWUFBSSxRQUFRLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsS0FBSyxDQUFDLEVBQUU7QUFDdkMsZ0JBQU0sR0FBQyxLQUFLLENBQUM7U0FDZDtBQUNELGtCQUFVLENBQUMsTUFBTSxDQUFDLEdBQUcsVUFBVSxDQUFDLElBQUksQ0FBQyxDQUFDO09BQ3ZDO0FBQ0QsVUFBSSxDQUFDLGlCQUFpQixJQUFJLE1BQU0sQ0FBQyxNQUFNLEdBQUMsQ0FBQyxFQUFFO0FBQ3pDLGlCQUFTO09BQ1Y7QUFDRCxVQUFJLFFBQVEsQ0FBQyxNQUFNLENBQUMsS0FBSyxTQUFTLElBQUksWUFBWSxDQUFDLE1BQU0sQ0FBQyxLQUFLLFNBQVMsSUFBSSxVQUFVLENBQUMsTUFBTSxDQUFDLEVBQUU7QUFDOUYsd0JBQWdCLENBQUMsSUFBSSxDQUFDLEVBQUUsR0FBRyxFQUFDLGtCQUFrQixDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsQ0FBQyxFQUFFLEdBQUcsRUFBQyxjQUFjLENBQUMsTUFBTSxDQUFDLEVBQUUsTUFBTSxFQUFDLE1BQU0sRUFBRSxLQUFLLEVBQUMsWUFBWSxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUMsQ0FBQztBQUMzSSxlQUFPLENBQUMsR0FBRyxDQUFDLG9CQUFvQixHQUFDLE1BQU0sR0FBQyxPQUFPLEdBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUM7T0FDbkU7S0FDRjs7QUFFRCxRQUFJLGdCQUFnQixDQUFDLE1BQU0sS0FBSyxDQUFDLEVBQUU7QUFDakMsYUFBTyxDQUFDLEdBQUcsQ0FBQyxpRUFBaUUsQ0FBQyxDQUFDO0tBQ2hGO0FBQ0QsV0FBTyxnQkFBZ0IsQ0FBQztHQUN6Qjs7Ozs7QUEzSUssaUJBQVcsR0FBRywyQ0FBMkM7QUFDekQsa0JBQVksR0FBRyxFQUFDLEdBQUcsRUFBQyxVQUFVLEVBQUMsSUFBSSxFQUFDLFVBQVUsRUFBQyxJQUFJLEVBQUMsVUFBVSxFQUFDLElBQUksRUFBQyxVQUFVLEVBQUMsSUFBSSxFQUFDLFVBQVUsRUFBQyxJQUFJLEVBQUMsV0FBVyxFQUFDLElBQUksRUFBQyxXQUFXLEVBQUMsSUFBSSxFQUFDLFdBQVcsRUFBQyxJQUFJLEVBQUMsV0FBVyxFQUFDLElBQUksRUFBQyxXQUFXLEVBQUMsSUFBSSxFQUFDLFlBQVksRUFBQyxLQUFLLEVBQUMscUJBQXFCLEVBQUMsS0FBSyxFQUFDLHNCQUFzQixFQUFDLEtBQUssRUFBQyxzQkFBc0IsRUFBQyxLQUFLLEVBQUMsb0JBQW9CLEVBQUMsS0FBSyxFQUFDLHFCQUFxQixFQUFDLEtBQUssRUFBQyxxQkFBcUIsRUFBQyxLQUFLLEVBQUMsc0JBQXNCLEVBQUMsS0FBSyxFQUFDLHNCQUFzQixFQUFDLEtBQUssRUFBQyx1QkFBdUIsRUFBQyxLQUFLLEVBQUMsd0JBQXdCLEVBQUM7QUFDdGUsaUJBQVcsR0FBRyxFQUFDLEdBQUcsRUFBQyxLQUFLLEVBQUMsSUFBSSxFQUFDLEtBQUssRUFBQyxJQUFJLEVBQUMsS0FBSyxFQUFDLElBQUksRUFBQyxLQUFLLEVBQUMsSUFBSSxFQUFDLEtBQUssRUFBQyxJQUFJLEVBQUMsS0FBSyxFQUFDLElBQUksRUFBQyxLQUFLLEVBQUMsSUFBSSxFQUFDLE1BQU0sRUFBQyxJQUFJLEVBQUMsTUFBTSxFQUFDLElBQUksRUFBQyxNQUFNLEVBQUMsSUFBSSxFQUFDLE1BQU0sRUFBQyxLQUFLLEVBQUMsS0FBSyxFQUFDLEtBQUssRUFBQyxLQUFLLEVBQUMsS0FBSyxFQUFDLEtBQUssRUFBQyxLQUFLLEVBQUMsS0FBSyxFQUFDLEtBQUssRUFBQyxLQUFLLEVBQUMsS0FBSyxFQUFDLEtBQUssRUFBQyxLQUFLLEVBQUMsS0FBSyxFQUFDLEtBQUssRUFBQyxLQUFLLEVBQUMsS0FBSyxFQUFDLEtBQUssRUFBQyxLQUFLLEVBQUMsS0FBSyxFQUFDO0FBQ25RLGtCQUFZLEdBQUcsQ0FBQyxHQUFHLEVBQUMsSUFBSSxFQUFDLElBQUksRUFBQyxJQUFJLEVBQUMsSUFBSSxFQUFDLEtBQUssRUFBQyxJQUFJLEVBQUMsSUFBSSxFQUFDLEtBQUssRUFBQyxJQUFJLEVBQUMsSUFBSSxFQUFDLEtBQUssRUFBQyxJQUFJLEVBQUMsS0FBSyxFQUFDLElBQUksRUFBQyxLQUFLLEVBQUMsS0FBSyxFQUFDLEtBQUssRUFBQyxLQUFLLENBQUM7QUFDdEgsaUJBQVcsR0FBRyxFQUFDLEtBQUssRUFBQyxNQUFNLEVBQUMsS0FBSyxFQUFDLEtBQUssRUFBQyxNQUFNLEVBQUMsS0FBSyxFQUFDLEtBQUssRUFBQyxLQUFLLEVBQUM7Ozs7QUFHakUsdUJBQWlCLEdBQUcsS0FBSzs7Z0NBdUl0QixjQUFjIiwiZmlsZSI6Inl0LWRvd25sb2FkZXIvbWFpbi5qcyIsInNvdXJjZXNDb250ZW50IjpbIid1c2Ugc3RyaWN0JztcblxuLypcblRoaXMgcHJvdmlkZXMgdGhlIGRvd25sb2FkYWJsZSBsaW5rIGZvciB5b3V0dWJlIHZpZGVvcy5cbk1vc3Qgb2YgdGhlIHJlZ2V4IGFuZCBjb25jZXB0cyBoYXZlIGJlZW4gcGlja2VkIHVwIGZyb20gaHR0cHM6Ly9naXRodWIuY29tL2dhbnR0L2Rvd25sb2FkeW91dHViZS5cblxuVGhlIGlkZWEgd291bGQgYmUgdG8gbW92ZSB0aGUgcGF0dGVybnMgYW5kIG90aGVyIGNvbmZpZyB0byBhIHdlYi1zZXJ2aWNlIHNvIHRoYXQgaWYgcGF0dGVybnMgY2hhbmdlIHdlIGNhbiBlYXNpbHkgdXBkYXRlIHRoZSBjaGFuZ2VzLlxuKi9cblxuXG5jb25zdCBUSVRMRV9SRUdFWCA9IC88bWV0YVxccytuYW1lPVwidGl0bGVcIlxccytjb250ZW50PVwiKFteXCJdKilcIj4vXG5jb25zdCBGT1JNQVRfTEFCRUwgPSB7JzUnOidGTFYgMjQwcCcsJzE4JzonTVA0IDM2MHAnLCcyMic6J01QNCA3MjBwJywnMzQnOidGTFYgMzYwcCcsJzM1JzonRkxWIDQ4MHAnLCczNyc6J01QNCAxMDgwcCcsJzM4JzonTVA0IDIxNjBwJywnNDMnOidXZWJNIDM2MHAnLCc0NCc6J1dlYk0gNDgwcCcsJzQ1JzonV2ViTSA3MjBwJywnNDYnOidXZWJNIDEwODBwJywnMTM1JzonTVA0IDQ4MHAgLSBubyBhdWRpbycsJzEzNyc6J01QNCAxMDgwcCAtIG5vIGF1ZGlvJywnMTM4JzonTVA0IDIxNjBwIC0gbm8gYXVkaW8nLCcxMzknOidNNEEgNDhrYnBzIC0gYXVkaW8nLCcxNDAnOidNNEEgMTI4a2JwcyAtIGF1ZGlvJywnMTQxJzonTTRBIDI1NmticHMgLSBhdWRpbycsJzI2NCc6J01QNCAxNDQwcCAtIG5vIGF1ZGlvJywnMjY2JzonTVA0IDIxNjBwIC0gbm8gYXVkaW8nLCcyOTgnOidNUDQgNzIwcDYwIC0gbm8gYXVkaW8nLCcyOTknOidNUDQgMTA4MHA2MCAtIG5vIGF1ZGlvJ307XG5jb25zdCBGT1JNQVRfVFlQRSA9IHsnNSc6J2ZsdicsJzE4JzonbXA0JywnMjInOidtcDQnLCczNCc6J2ZsdicsJzM1JzonZmx2JywnMzcnOidtcDQnLCczOCc6J21wNCcsJzQzJzond2VibScsJzQ0Jzond2VibScsJzQ1Jzond2VibScsJzQ2Jzond2VibScsJzEzNSc6J21wNCcsJzEzNyc6J21wNCcsJzEzOCc6J21wNCcsJzEzOSc6J200YScsJzE0MCc6J200YScsJzE0MSc6J200YScsJzI2NCc6J21wNCcsJzI2Nic6J21wNCcsJzI5OCc6J21wNCcsJzI5OSc6J21wNCd9O1xuY29uc3QgRk9STUFUX09SREVSID0gWyc1JywnMTgnLCczNCcsJzQzJywnMzUnLCcxMzUnLCc0NCcsJzIyJywnMjk4JywnNDUnLCczNycsJzI5OScsJzQ2JywnMjY0JywnMzgnLCcyNjYnLCcxMzknLCcxNDAnLCcxNDEnXTtcbmNvbnN0IEZPUk1BVF9SVUxFID0geydmbHYnOidub25lJywnbXA0JzonYWxsJywnd2VibSc6J21heCcsJ200YSc6J21heCd9O1xuLy8gYWxsID0gZGlzcGxheSBhbGwgdmVyc2lvbnMsIG1heCA9IG9ubHkgaGlnaGVzdCBxdWFsaXR5IHZlcnNpb24sIG5vbmUgPSBubyB2ZXJzaW9uXG4vLyB0aGUgZGVmYXVsdCBzZXR0aW5ncyBzaG93IGFsbCBNUDQgdmlkZW9zLCB0aGUgaGlnaGVzdCBxdWFsaXR5IEZMViBhbmQgbm8gV2ViTVxuY29uc3QgU0hPV19EQVNIX0ZPUk1BVFMgPSBmYWxzZTtcblxuZnVuY3Rpb24gZmluZE1hdGNoKHRleHQsIHJlZ2V4cCkge1xuICAgIGNvbnN0IG1hdGNoZXMgPSB0ZXh0Lm1hdGNoKHJlZ2V4cCk7XG4gICAgcmV0dXJuIChtYXRjaGVzKSA/IG1hdGNoZXNbMV0gOiBudWxsO1xufVxuXG5mdW5jdGlvbiBmaW5kVmlkZW9MaW5rcyh5b3V0dWJlUGFnZUNvbnRlbnQpIHtcbiAgb3NBUEkubm90aWZ5WW91dHViZVZpZGVvVXJscyhnZXRfbGlua3MoeW91dHViZVBhZ2VDb250ZW50KSk7XG59XG5cbmZ1bmN0aW9uIGdldFNlcGFyYXRvcnModmlkZW9Gb3JtYXRzKSB7XG4gIGxldCBzZXAxLCBzZXAyLCBzZXAzO1xuICBpZiAodmlkZW9Gb3JtYXRzLmluZGV4T2YoJywnKSA+IC0xKSB7XG4gICAgc2VwMSA9ICcsJztcbiAgICBzZXAyID0gKHZpZGVvRm9ybWF0cy5pbmRleE9mKCcmJykgPiAtMSkgPyAnJicgOiAnXFxcXHUwMDI2JztcbiAgICBzZXAzID0gJz0nO1xuICB9IGVsc2Uge1xuICAgIHNlcDEgPSAnJTJDJztcbiAgICBzZXAyID0gJyUyNic7XG4gICAgc2VwMyA9ICclM0QnO1xuICB9XG4gIHJldHVybiB7IHNlcDEsIHNlcDIsIHNlcDMgfTtcbn1cblxuZnVuY3Rpb24gZ2V0X2xpbmtzKGJvZHlDb250ZW50KSB7XG4gIGxldCB2aWRlb0lEID0gbnVsbCxcbiAgICAgIHZpZGVvRm9ybWF0cyxcbiAgICAgIHZpZGVvQWRhcHRGb3JtYXRzLFxuICAgICAgdmlkZW9NYW5pZmVzdFVSTDtcblxuICBpZiAoYm9keUNvbnRlbnQgIT09IG51bGwpIHtcbiAgICB2aWRlb0lEID0gZmluZE1hdGNoKGJvZHlDb250ZW50LCAvXFxcInZpZGVvX2lkXFxcIjpcXHMqXFxcIihbXlxcXCJdKylcXFwiLyk7XG4gICAgdmlkZW9Gb3JtYXRzID0gZmluZE1hdGNoKGJvZHlDb250ZW50LCAvXFxcInVybF9lbmNvZGVkX2ZtdF9zdHJlYW1fbWFwXFxcIjpcXHMqXFxcIihbXlxcXCJdKylcXFwiLyk7XG4gICAgdmlkZW9BZGFwdEZvcm1hdHMgPSBmaW5kTWF0Y2goYm9keUNvbnRlbnQsIC9cXFwiYWRhcHRpdmVfZm10c1xcXCI6XFxzKlxcXCIoW15cXFwiXSspXFxcIi8pO1xuICAgIHZpZGVvTWFuaWZlc3RVUkwgPSBmaW5kTWF0Y2goYm9keUNvbnRlbnQsIC9cXFwiZGFzaG1wZFxcXCI6XFxzKlxcXCIoW15cXFwiXSspXFxcIi8pO1xuICB9XG5cbiAgbGV0IHZpZGVvVGl0bGUgPSBmaW5kTWF0Y2goYm9keUNvbnRlbnQsIFRJVExFX1JFR0VYKTtcbiAgdmlkZW9UaXRsZSA9ICh2aWRlb1RpdGxlKSA/IHZpZGVvVGl0bGUgOiAnWW91dHViZSBWaWRlbyc7XG5cbiAgLy8gcGFyc2UgdGhlIGZvcm1hdHMgbWFwXG4gIGNvbnN0IHsgc2VwMSwgc2VwMiwgc2VwMyB9ID0gZ2V0U2VwYXJhdG9ycyh2aWRlb0Zvcm1hdHMpO1xuXG5cbiAgbGV0IHZpZGVvVVJMID0gW107XG4gIGxldCB2aWRlb1NpZ25hdHVyZSA9IFtdO1xuICBpZiAodmlkZW9BZGFwdEZvcm1hdHMpIHtcbiAgICB2aWRlb0Zvcm1hdHMgPSB2aWRlb0Zvcm1hdHMgKyBzZXAxICsgdmlkZW9BZGFwdEZvcm1hdHM7XG4gIH1cblxuICBsZXQgdmlkZW9Gb3JtYXRzR3JvdXAgPSB2aWRlb0Zvcm1hdHMuc3BsaXQoc2VwMSk7XG4gIGZvciAobGV0IGkgPSAwOyBpIDwgdmlkZW9Gb3JtYXRzR3JvdXAubGVuZ3RoOyBpKyspIHtcbiAgICBsZXQgdmlkZW9Gb3JtYXRzRWxlbSA9IHZpZGVvRm9ybWF0c0dyb3VwW2ldLnNwbGl0KHNlcDIpO1xuICAgIGxldCB2aWRlb0Zvcm1hdHNQYWlyID0gW107XG4gICAgZm9yIChsZXQgaiA9IDA7IGo8dmlkZW9Gb3JtYXRzRWxlbS5sZW5ndGg7IGorKykge1xuICAgICAgbGV0IHBhaXIgPSB2aWRlb0Zvcm1hdHNFbGVtW2pdLnNwbGl0KHNlcDMpO1xuICAgICAgaWYgKHBhaXIubGVuZ3RoID09PSAyKSB7XG4gICAgICAgIHZpZGVvRm9ybWF0c1BhaXJbcGFpclswXV0gPSBwYWlyWzFdO1xuICAgICAgfVxuICAgIH1cbiAgICBpZiAodmlkZW9Gb3JtYXRzUGFpclsndXJsJ10gPT09IG51bGwpIHtcbiAgICAgIGNvbnRpbnVlO1xuICAgIH1cbiAgICBsZXQgdXJsID0gdW5lc2NhcGUodW5lc2NhcGUodmlkZW9Gb3JtYXRzUGFpclsndXJsJ10pKS5yZXBsYWNlKC9cXFxcXFwvL2csJy8nKS5yZXBsYWNlKC9cXFxcdTAwMjYvZywnJicpO1xuICAgIGlmICh2aWRlb0Zvcm1hdHNQYWlyWydpdGFnJ10gPT09IG51bGwpIHtcbiAgICAgIGNvbnRpbnVlO1xuICAgIH1cbiAgICBsZXQgaXRhZyA9IHZpZGVvRm9ybWF0c1BhaXJbJ2l0YWcnXTtcbiAgICBsZXQgc2lnID0gdmlkZW9Gb3JtYXRzUGFpclsnc2lnJ118fHZpZGVvRm9ybWF0c1BhaXJbJ3NpZ25hdHVyZSddO1xuICAgIGlmIChzaWcpIHtcbiAgICAgIHVybCA9IHVybCsnJnNpZ25hdHVyZT0nICsgc2lnO1xuICAgICAgdmlkZW9TaWduYXR1cmVbaXRhZ10gPSBudWxsO1xuICAgIH1cbiAgICBlbHNlIGlmICh2aWRlb0Zvcm1hdHNQYWlyWydzJ10pIHtcbiAgICAgIHVybCA9IHVybCsnJnNpZ25hdHVyZT0nICsgdmlkZW9Gb3JtYXRzUGFpclsncyddO1xuICAgICAgdmlkZW9TaWduYXR1cmVbaXRhZ10gPSB2aWRlb0Zvcm1hdHNQYWlyWydzJ107XG4gICAgfVxuICAgIGlmICh1cmwudG9Mb3dlckNhc2UoKS5pbmRleE9mKCdyYXRlYnlwYXNzJykgPT09IC0xKSB7IC8vIHNwZWVkIHVwIGRvd25sb2FkIGZvciBkYXNoXG4gICAgICB1cmwgPSB1cmwrJyZyYXRlYnlwYXNzID0geWVzJztcbiAgICB9XG4gICAgaWYgKHVybC50b0xvd2VyQ2FzZSgpLmluZGV4T2YoJ2h0dHAnKSA9PT0gMCkgeyAvLyB2YWxpZGF0ZSBVUkxcbiAgICAgIHZpZGVvVVJMW2l0YWddID0gdXJsICsgJyZ0aXRsZT0nICsgdmlkZW9UaXRsZTtcbiAgICB9XG4gIH1cblxuICBsZXQgc2hvd0Zvcm1hdCA9IFtdO1xuICBmb3IgKGxldCBjYXRlZ29yeSBpbiBGT1JNQVRfUlVMRSkge1xuICAgIGNvbnN0IHJ1bGUgPSBGT1JNQVRfUlVMRVtjYXRlZ29yeV07XG4gICAgZm9yIChsZXQgaW5kZXggaW4gRk9STUFUX1RZUEUpe1xuICAgICAgaWYgKEZPUk1BVF9UWVBFW2luZGV4XSA9PT0gY2F0ZWdvcnkpIHtcbiAgICAgICAgc2hvd0Zvcm1hdFtpbmRleF0gPSAocnVsZSA9PT0gJ2FsbCcpO1xuICAgICAgfVxuICAgIH1cbiAgICBpZiAocnVsZSA9PT0gJ21heCcpIHtcbiAgICAgIGZvciAobGV0IGkgPSBGT1JNQVRfT1JERVIubGVuZ3RoLTE7IGkgPj0gMDsgaS0tKSB7XG4gICAgICAgIGxldCBmb3JtYXQgPSBGT1JNQVRfT1JERVJbaV07XG4gICAgICAgIGlmIChGT1JNQVRfVFlQRVtmb3JtYXRdID09PSBjYXRlZ29yeSAmJiB2aWRlb1VSTFtmb3JtYXRdICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICBzaG93Rm9ybWF0W2Zvcm1hdF0gPSB0cnVlO1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgbGV0IGRvd25sb2FkQ29kZUxpc3QgPSBbXTtcbiAgZm9yIChsZXQgaSA9IDA7IGkgPCBGT1JNQVRfT1JERVIubGVuZ3RoOyBpKyspIHtcbiAgICBsZXQgZm9ybWF0ID0gRk9STUFUX09SREVSW2ldO1xuICAgIGlmIChmb3JtYXQgPT09ICczNycgJiYgdmlkZW9VUkxbZm9ybWF0XSA9PT0gdW5kZWZpbmVkKSB7IC8vIGhhY2sgZm9yIGRhc2ggMTA4MHBcbiAgICAgIGlmICh2aWRlb1VSTFsnMTM3J10pIHtcbiAgICAgICBmb3JtYXQgPSAnMTM3JztcbiAgICAgIH1cbiAgICAgIHNob3dGb3JtYXRbZm9ybWF0XSA9IHNob3dGb3JtYXRbJzM3J107XG4gICAgfSBlbHNlIGlmIChmb3JtYXQgPT09ICczOCcgJiYgdmlkZW9VUkxbZm9ybWF0XSA9PT0gdW5kZWZpbmVkKSB7IC8vIGhhY2sgZm9yIGRhc2ggNEtcbiAgICAgIGlmICh2aWRlb1VSTFsnMTM4J10gJiYgIXZpZGVvVVJMWycyNjYnXSkge1xuICAgICAgICBmb3JtYXQ9JzEzOCc7XG4gICAgICB9XG4gICAgICBzaG93Rm9ybWF0W2Zvcm1hdF0gPSBzaG93Rm9ybWF0WyczOCddO1xuICAgIH1cbiAgICBpZiAoIVNIT1dfREFTSF9GT1JNQVRTICYmIGZvcm1hdC5sZW5ndGg+Mikge1xuICAgICAgY29udGludWU7XG4gICAgfVxuICAgIGlmICh2aWRlb1VSTFtmb3JtYXRdICE9PSB1bmRlZmluZWQgJiYgRk9STUFUX0xBQkVMW2Zvcm1hdF0gIT09IHVuZGVmaW5lZCAmJiBzaG93Rm9ybWF0W2Zvcm1hdF0pIHtcbiAgICAgIGRvd25sb2FkQ29kZUxpc3QucHVzaCh7IHVybDplbmNvZGVVUklDb21wb25lbnQodmlkZW9VUkxbZm9ybWF0XSksIHNpZzp2aWRlb1NpZ25hdHVyZVtmb3JtYXRdLCBmb3JtYXQ6Zm9ybWF0LCBsYWJlbDpGT1JNQVRfTEFCRUxbZm9ybWF0XSB9KTtcbiAgICAgIGNvbnNvbGUubG9nKCdEWVZBTSAtIEluZm86IGl0YWcnK2Zvcm1hdCsnIHVybDonK3ZpZGVvVVJMW2Zvcm1hdF0pO1xuICAgIH1cbiAgfVxuXG4gIGlmIChkb3dubG9hZENvZGVMaXN0Lmxlbmd0aCA9PT0gMCkge1xuICAgIGNvbnNvbGUubG9nKCdObyBkb3dubG9hZCBVUkwgZm91bmQuIFByb2JhYmx5IFlvdVR1YmUgdXNlcyBlbmNyeXB0ZWQgc3RyZWFtcy4nKTtcbiAgfVxuICByZXR1cm4gZG93bmxvYWRDb2RlTGlzdDtcbn1cblxuXG5leHBvcnQgeyBmaW5kVmlkZW9MaW5rcyBhcyBmaW5kVmlkZW9MaW5rcyB9O1xuIl19