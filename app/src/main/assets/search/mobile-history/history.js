System.register('mobile-history/history', ['core/cliqz', 'core/templates', 'mobile-history/webview'], function (_export) {
  /* global osAPI, math */

  'use strict';var utils, handlebars, document, Hammer, historyTimer, allHistory, allFavorites, History;

  function showHistory(history) {
    clearTimeout(historyTimer);

    allHistory = history;
    var queries = utils.getLocalStorage().getObject('recentQueries', []).reverse();

    history.forEach(function (item) {
      item.domain = item.url.match(/^(?:https?:\/\/)?(?:www\.)?([^\/]+)/i)[1];
    });

    var historyWithLogos = addLogos(history);
    var data = mixHistoryWithQueries(queries, historyWithLogos);
    History.displayData(data, History.showOnlyFavorite);
  }

  function showFavorites(favorites) {
    clearTimeout(historyTimer);

    allFavorites = favorites;

    favorites.forEach(function (item) {
      item.domain = item.url.match(/^(?:https?:\/\/)?(?:www\.)?([^\/]+)/i)[1];
    });

    var favoritesWithLogos = addLogos(favorites);

    History.displayData(favoritesWithLogos, History.showOnlyFavorite);
  }

  function addLogos(list) {
    return list.map(function (item) {
      var details = utils.getDetailsFromUrl(item.url);
      item.logo = utils.getLogoDetails(details);
      return item;
    });
  }

  function sendShowTelemetry(data, type) {
    var queryCount = data.filter(function (item) {
      return item.query;
    }).length,
        urlCount = data.filter(function (item) {
      return item.url;
    }).length;
    utils.telemetry({
      type: type,
      action: 'show',
      active_day_count: data.length - queryCount - urlCount,
      query_count: queryCount,
      url_count: urlCount
    });
  }

  function mixHistoryWithQueries(queries, history) {
    var data = [];
    var hi = 0;
    var qi = 0;
    var date = '';
    while (true) {
      if (hi >= history.length || qi >= queries.length) {
        break;
      }

      if (history[hi].timestamp <= queries[qi].timestamp) {
        if (getDateFromTimestamp(history[hi].timestamp) !== date) {
          data.push({ date: getDateFromTimestamp(history[hi].timestamp) });
          date = getDateFromTimestamp(history[hi].timestamp);
        }
        data.push(history[hi]);

        hi++;
      } else {
        if (getDateFromTimestamp(queries[qi].timestamp) !== date) {
          data.push({ date: getDateFromTimestamp(queries[qi].timestamp) });
          date = getDateFromTimestamp(queries[qi].timestamp);
        }
        data.push(queries[qi]);
        qi++;
      }
    }
    while (hi < history.length) {
      if (getDateFromTimestamp(history[hi].timestamp) !== date) {
        data.push({ date: getDateFromTimestamp(history[hi].timestamp) });
        date = getDateFromTimestamp(history[hi].timestamp);
      }
      data.push(history[hi]);
      hi++;
    }
    while (qi < queries.length) {
      if (getDateFromTimestamp(queries[qi].timestamp) !== date) {
        data.push({ date: getDateFromTimestamp(queries[qi].timestamp) });
        date = getDateFromTimestamp(queries[qi].timestamp);
      }
      data.push(queries[qi]);
      qi++;
    }

    return data;
  }

  function displayData(data) {
    var isFavorite = arguments.length <= 1 || arguments[1] === undefined ? false : arguments[1];

    if (!handlebars.tplCache['conversations']) {
      return setTimeout(History.displayData, 100, data);
    }

    var template = isFavorite ? 'favorites' : 'conversations';
    document.body.innerHTML = handlebars.tplCache[template]({ data: data });

    var B = document.body,
        H = document.documentElement;

    var height = undefined;

    if (typeof document.height !== 'undefined') {
      height = document.height; // For webkit browsers
    } else {
        height = Math.max(B.scrollHeight, B.offsetHeight, H.clientHeight, H.scrollHeight, H.offsetHeight);
      }

    document.body.scrollTop = height + 100;

    attachListeners(document.getElementById('container'));

    var type = isFavorite ? 'favorites' : 'history';
    History.sendShowTelemetry(data, type);
  }

  function getDateFromTimestamp(time) {
    var d = new Date(time);

    var days = d.getDate();
    days = days > 9 ? days : '0' + days;

    var months = d.getMonth() + 1;
    months = months > 9 ? months : '0' + months;

    var year = d.getFullYear();

    var formatedDate = days + '.' + months + '.' + year;
    return formatedDate;
  }
  function removeQuery(id) {
    var queries = utils.getLocalStorage().getObject('recentQueries', []);

    queries = queries.filter(function (query) {
      return id !== query.id;
    });
    utils.getLocalStorage().setObject('recentQueries', queries);
  }

  function removeHistoryItem(id) {
    allHistory = allHistory.filter(function (history) {
      return id !== history.id;
    });
    osAPI.removeHistoryItems([id]);
  }

  function removeItem(item) {
    var id = parseInt(item.dataset.id);
    item.getAttribute('class').indexOf('question') >= 0 ? removeQuery(id) : removeHistoryItem(id);
  }

  function unfavoriteItem(item) {
    var url = item.getAttribute('data');
    var title = item.dataset.title;
    osAPI.setFavorites([{ title: title, url: url }], false);
  }

  function init(onlyFavorites) {
    migrateQueries();
    History.showOnlyFavorite = onlyFavorites;
    subscribeEvents();
    update();
  }

  function update() {
    var callback = History.showOnlyFavorite ? showFavorites : showHistory;
    historyTimer = setTimeout(callback, 500, []);
    History.showOnlyFavorite ? osAPI.getFavorites('History.showFavorites') : osAPI.getHistoryItems('History.showHistory');
  }

  function clearHistory() {
    utils.getLocalStorage().setObject('recentQueries', []);
  }

  function clearFavorites() {
    utils.getLocalStorage().setObject('favoriteQueries', []);
  }

  function onElementClick(event) {
    var element = event.srcEvent.currentTarget;
    var type = element.getAttribute('class');
    var clickAction = type.indexOf('question') >= 0 ? osAPI.notifyQuery : osAPI.openLink;
    clickAction(element.getAttribute('data'));
    sendClickTelemetry(element);
  }

  function sendClickTelemetry(element) {
    var targeType = element.className.indexOf('question') >= 0 ? 'query' : 'url';
    utils.telemetry({
      type: History.showOnlyFavorite ? 'favorites' : 'history',
      action: 'click',
      target_type: targeType,
      target_index: parseInt(element.dataset.index),
      target_length: element.getAttribute('data').length,
      target_ts: parseInt(element.dataset.timestamp)
    });
  }

  function crossTransform(element, x) {
    var platforms = ['', '-webkit-', '-ms-'];
    platforms.forEach(function (platform) {
      element.style[platform + 'transform'] = 'translate3d(' + x + 'px, 0px, 0px)';
    });
  }

  function isElementDate(element) {
    return !element.dataset.timestamp;
  }

  function attachListeners(list) {
    var listItems = list.getElementsByTagName("li");

    for (var i = 0; i < listItems.length; i++) {
      if (!isElementDate(listItems[i])) {
        new Hammer(listItems[i]).on('pan', onSwipe);
        new Hammer(listItems[i]).on('panend', onSwipeEnd);
        new Hammer(listItems[i]).on('tap', onElementClick);
      }
    }
  }

  function removeDomElement(element) {
    var prev = element.previousElementSibling;
    var next = element.nextElementSibling;
    if (prev && isElementDate(prev)) {
      if (!next || isElementDate(next)) {
        element.parentElement.removeChild(prev);
      }
    }
    element.parentElement.removeChild(element);
  }

  function onSwipe(e) {
    crossTransform(e.srcEvent.currentTarget, e.deltaX);
  }
  function onSwipeEnd(e) {
    var element = e.srcEvent.currentTarget;
    if (math.abs(e.velocityX) < -1 || math.abs(e.deltaX) > 150) {
      History.showOnlyFavorite ? unfavoriteItem(element) : removeItem(element);
      removeDomElement(element);
    } else {
      crossTransform(element, 0);
    }
  }

  /**
    This function is for migration of history and favorite queries
    to extension version Mobile Extension 3.5.2
  **/
  function migrateQueries() {
    if (utils.getLocalStorage().getItem('isFavoritesRefactored')) {
      return;
    }
    var queries = utils.getLocalStorage().getObject('recentQueries', []);
    var favoriteQueries = utils.getLocalStorage().getObject('favoriteQueries', []);
    queries = queries.map(function (query) {
      if (query.favorite) {
        favoriteQueries.unshift({ query: query.query, timestamp: query.timestamp });
      }
      delete query.favorite;
      return query;
    });
    utils.getLocalStorage().setObject('recentQueries', queries);
    utils.getLocalStorage().setObject('favoriteQueries', favoriteQueries);
    utils.getLocalStorage().setItem('isFavoritesRefactored', true);
  }

  function subscribeEvents() {
    CliqzEvents.sub('show', jsAPI.onShow);
    CliqzEvents.sub('clear_favorites', jsAPI.clearFavorites);
    CliqzEvents.sub('clear_history', jsAPI.clearHistory);
  }

  return {
    setters: [function (_coreCliqz) {
      utils = _coreCliqz.utils;
    }, function (_coreTemplates) {
      handlebars = _coreTemplates['default'];
    }, function (_mobileHistoryWebview) {
      document = _mobileHistoryWebview.document;
      Hammer = _mobileHistoryWebview.Hammer;
    }],
    execute: function () {
      allHistory = [];
      allFavorites = [];
      History = {
        init: init,
        update: update,
        showHistory: showHistory,
        showFavorites: showFavorites,
        clearHistory: clearHistory,
        clearFavorites: clearFavorites,
        displayData: displayData,
        sendShowTelemetry: sendShowTelemetry,
        showOnlyFavorite: false
      };

      _export('default', History);
    }
  };
});
//# sourceMappingURL=data:application/json;base64,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cUJBQWEsRUFBYixhQUFhO0FBQ2Isb0JBQVksRUFBWixZQUFZO0FBQ1osc0JBQWMsRUFBZCxjQUFjO0FBQ2QsbUJBQVcsRUFBWCxXQUFXO0FBQ1gseUJBQWlCLEVBQWpCLGlCQUFpQjtBQUNqQix3QkFBZ0IsRUFBRSxLQUFLO09BQ3hCOzt5QkFFYyxPQUFPIiwiZmlsZSI6Im1vYmlsZS1oaXN0b3J5L2hpc3RvcnkuanMiLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIHN0cmljdCc7XG4vKiBnbG9iYWwgb3NBUEksIG1hdGggKi9cblxuaW1wb3J0IHsgdXRpbHMgfSBmcm9tICdjb3JlL2NsaXF6JztcbmltcG9ydCBoYW5kbGViYXJzIGZyb20gJ2NvcmUvdGVtcGxhdGVzJztcbmltcG9ydCB7IGRvY3VtZW50LCBIYW1tZXIgfSBmcm9tICdtb2JpbGUtaGlzdG9yeS93ZWJ2aWV3JztcblxudmFyIGhpc3RvcnlUaW1lcjtcbnZhciBhbGxIaXN0b3J5ID0gW107XG52YXIgYWxsRmF2b3JpdGVzID0gW107XG5cbmZ1bmN0aW9uIHNob3dIaXN0b3J5KGhpc3RvcnkpIHtcbiAgY2xlYXJUaW1lb3V0KGhpc3RvcnlUaW1lcik7XG5cbiAgYWxsSGlzdG9yeSA9IGhpc3Rvcnk7XG4gIGNvbnN0IHF1ZXJpZXMgPSB1dGlscy5nZXRMb2NhbFN0b3JhZ2UoKS5nZXRPYmplY3QoJ3JlY2VudFF1ZXJpZXMnLCBbXSkucmV2ZXJzZSgpO1xuXG4gIGhpc3RvcnkuZm9yRWFjaChpdGVtID0+IHtcbiAgICBpdGVtLmRvbWFpbiA9IGl0ZW0udXJsLm1hdGNoKC9eKD86aHR0cHM/OlxcL1xcLyk/KD86d3d3XFwuKT8oW15cXC9dKykvaSlbMV07XG4gIH0pO1xuXG4gIGNvbnN0IGhpc3RvcnlXaXRoTG9nb3MgPSBhZGRMb2dvcyhoaXN0b3J5KTtcbiAgY29uc3QgZGF0YSA9IG1peEhpc3RvcnlXaXRoUXVlcmllcyhxdWVyaWVzLCBoaXN0b3J5V2l0aExvZ29zKTtcbiAgSGlzdG9yeS5kaXNwbGF5RGF0YShkYXRhLCBIaXN0b3J5LnNob3dPbmx5RmF2b3JpdGUpO1xufVxuXG5mdW5jdGlvbiBzaG93RmF2b3JpdGVzKGZhdm9yaXRlcykge1xuICBjbGVhclRpbWVvdXQoaGlzdG9yeVRpbWVyKTtcblxuICBhbGxGYXZvcml0ZXMgPSBmYXZvcml0ZXM7XG5cbiAgZmF2b3JpdGVzLmZvckVhY2goaXRlbSA9PiB7XG4gICAgaXRlbS5kb21haW4gPSBpdGVtLnVybC5tYXRjaCgvXig/Omh0dHBzPzpcXC9cXC8pPyg/Ond3d1xcLik/KFteXFwvXSspL2kpWzFdO1xuICB9KTtcblxuICBjb25zdCBmYXZvcml0ZXNXaXRoTG9nb3MgPSBhZGRMb2dvcyhmYXZvcml0ZXMpO1xuXG4gIEhpc3RvcnkuZGlzcGxheURhdGEoZmF2b3JpdGVzV2l0aExvZ29zLCBIaXN0b3J5LnNob3dPbmx5RmF2b3JpdGUpO1xufVxuXG5mdW5jdGlvbiBhZGRMb2dvcyhsaXN0KSB7XG4gIHJldHVybiBsaXN0Lm1hcChpdGVtID0+IHtcbiAgICBjb25zdCBkZXRhaWxzID0gdXRpbHMuZ2V0RGV0YWlsc0Zyb21VcmwoaXRlbS51cmwpO1xuICAgIGl0ZW0ubG9nbyA9IHV0aWxzLmdldExvZ29EZXRhaWxzKGRldGFpbHMpO1xuICAgIHJldHVybiBpdGVtO1xuICB9KTtcbn1cblxuZnVuY3Rpb24gc2VuZFNob3dUZWxlbWV0cnkoZGF0YSwgdHlwZSkge1xuICBjb25zdCBxdWVyeUNvdW50ID0gZGF0YS5maWx0ZXIoZnVuY3Rpb24gKGl0ZW0pIHsgcmV0dXJuIGl0ZW0ucXVlcnk7IH0pLmxlbmd0aCxcbiAgICAgIHVybENvdW50ID0gZGF0YS5maWx0ZXIoZnVuY3Rpb24gKGl0ZW0pIHsgcmV0dXJuIGl0ZW0udXJsOyB9KS5sZW5ndGg7XG4gIHV0aWxzLnRlbGVtZXRyeSh7XG4gICAgdHlwZSxcbiAgICBhY3Rpb246ICdzaG93JyxcbiAgICBhY3RpdmVfZGF5X2NvdW50OiBkYXRhLmxlbmd0aCAtIHF1ZXJ5Q291bnQgLSB1cmxDb3VudCxcbiAgICBxdWVyeV9jb3VudDogcXVlcnlDb3VudCxcbiAgICB1cmxfY291bnQ6IHVybENvdW50XG4gIH0pO1xufVxuXG5cbmZ1bmN0aW9uIG1peEhpc3RvcnlXaXRoUXVlcmllcyhxdWVyaWVzLCBoaXN0b3J5KSB7XG4gIGxldCBkYXRhID0gW107XG4gIGxldCBoaSA9IDA7XG4gIGxldCBxaSA9IDA7XG4gIGxldCBkYXRlID0gJyc7XG4gIHdoaWxlICh0cnVlKSB7XG4gICAgaWYgKGhpID49IGhpc3RvcnkubGVuZ3RoIHx8IHFpID49IHF1ZXJpZXMubGVuZ3RoKSB7XG4gICAgICBicmVhaztcbiAgICB9XG5cbiAgICBpZiAoaGlzdG9yeVtoaV0udGltZXN0YW1wIDw9IHF1ZXJpZXNbcWldLnRpbWVzdGFtcCkge1xuICAgICAgaWYgKGdldERhdGVGcm9tVGltZXN0YW1wKGhpc3RvcnlbaGldLnRpbWVzdGFtcCkgIT09IGRhdGUpIHtcbiAgICAgICAgZGF0YS5wdXNoKHtkYXRlOiBnZXREYXRlRnJvbVRpbWVzdGFtcChoaXN0b3J5W2hpXS50aW1lc3RhbXApfSk7XG4gICAgICAgIGRhdGUgPSBnZXREYXRlRnJvbVRpbWVzdGFtcChoaXN0b3J5W2hpXS50aW1lc3RhbXApO1xuICAgICAgfVxuICAgICAgZGF0YS5wdXNoKGhpc3RvcnlbaGldKTtcblxuICAgICAgaGkrKztcbiAgICB9IGVsc2Uge1xuICAgICAgaWYgKGdldERhdGVGcm9tVGltZXN0YW1wKHF1ZXJpZXNbcWldLnRpbWVzdGFtcCkgIT09IGRhdGUpIHtcbiAgICAgICAgZGF0YS5wdXNoKHtkYXRlOiBnZXREYXRlRnJvbVRpbWVzdGFtcChxdWVyaWVzW3FpXS50aW1lc3RhbXApfSk7XG4gICAgICAgIGRhdGUgPSBnZXREYXRlRnJvbVRpbWVzdGFtcChxdWVyaWVzW3FpXS50aW1lc3RhbXApO1xuICAgICAgfVxuICAgICAgZGF0YS5wdXNoKHF1ZXJpZXNbcWldKTtcbiAgICAgIHFpKys7XG4gICAgfVxuICB9XG4gIHdoaWxlIChoaSA8IGhpc3RvcnkubGVuZ3RoKSB7XG4gICAgaWYgKGdldERhdGVGcm9tVGltZXN0YW1wKGhpc3RvcnlbaGldLnRpbWVzdGFtcCkgIT09IGRhdGUpIHtcbiAgICAgIGRhdGEucHVzaCh7ZGF0ZTogZ2V0RGF0ZUZyb21UaW1lc3RhbXAoaGlzdG9yeVtoaV0udGltZXN0YW1wKX0pO1xuICAgICAgZGF0ZSA9IGdldERhdGVGcm9tVGltZXN0YW1wKGhpc3RvcnlbaGldLnRpbWVzdGFtcCk7XG4gICAgfVxuICAgIGRhdGEucHVzaChoaXN0b3J5W2hpXSk7XG4gICAgaGkrKztcbiAgfVxuICB3aGlsZSAocWkgPCBxdWVyaWVzLmxlbmd0aCkge1xuICAgIGlmIChnZXREYXRlRnJvbVRpbWVzdGFtcChxdWVyaWVzW3FpXS50aW1lc3RhbXApICE9PSBkYXRlKSB7XG4gICAgICBkYXRhLnB1c2goe2RhdGU6IGdldERhdGVGcm9tVGltZXN0YW1wKHF1ZXJpZXNbcWldLnRpbWVzdGFtcCl9KTtcbiAgICAgIGRhdGUgPSBnZXREYXRlRnJvbVRpbWVzdGFtcChxdWVyaWVzW3FpXS50aW1lc3RhbXApO1xuICAgIH1cbiAgICBkYXRhLnB1c2gocXVlcmllc1txaV0pO1xuICAgIHFpKys7XG4gIH1cblxuICByZXR1cm4gZGF0YTtcbn1cblxuZnVuY3Rpb24gZGlzcGxheURhdGEoZGF0YSwgaXNGYXZvcml0ZSA9IGZhbHNlKSB7XG4gIGlmICghaGFuZGxlYmFycy50cGxDYWNoZVsnY29udmVyc2F0aW9ucyddKSB7XG4gICAgcmV0dXJuIHNldFRpbWVvdXQoSGlzdG9yeS5kaXNwbGF5RGF0YSwgMTAwLCBkYXRhKTtcbiAgfVxuXG4gIGNvbnN0IHRlbXBsYXRlID0gaXNGYXZvcml0ZSA/ICdmYXZvcml0ZXMnIDogJ2NvbnZlcnNhdGlvbnMnO1xuICBkb2N1bWVudC5ib2R5LmlubmVySFRNTCA9IGhhbmRsZWJhcnMudHBsQ2FjaGVbdGVtcGxhdGVdKHtkYXRhOiBkYXRhfSk7XG5cbiAgY29uc3QgQiA9IGRvY3VtZW50LmJvZHksXG4gICAgICBIID0gZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50O1xuXG4gIGxldCBoZWlnaHQ7XG5cbiAgaWYgKHR5cGVvZiBkb2N1bWVudC5oZWlnaHQgIT09ICd1bmRlZmluZWQnKSB7XG4gICAgICBoZWlnaHQgPSBkb2N1bWVudC5oZWlnaHQ7IC8vIEZvciB3ZWJraXQgYnJvd3NlcnNcbiAgfSBlbHNlIHtcbiAgICAgIGhlaWdodCA9IE1hdGgubWF4KCBCLnNjcm9sbEhlaWdodCwgQi5vZmZzZXRIZWlnaHQsSC5jbGllbnRIZWlnaHQsIEguc2Nyb2xsSGVpZ2h0LCBILm9mZnNldEhlaWdodCApO1xuICB9XG5cbiAgZG9jdW1lbnQuYm9keS5zY3JvbGxUb3AgPSBoZWlnaHQgKyAxMDA7XG5cbiAgYXR0YWNoTGlzdGVuZXJzKGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdjb250YWluZXInKSk7XG5cbiAgY29uc3QgdHlwZSA9IGlzRmF2b3JpdGUgPyAnZmF2b3JpdGVzJyA6ICdoaXN0b3J5JztcbiAgSGlzdG9yeS5zZW5kU2hvd1RlbGVtZXRyeShkYXRhLCB0eXBlKTtcbn1cblxuZnVuY3Rpb24gZ2V0RGF0ZUZyb21UaW1lc3RhbXAodGltZSkge1xuICAgIGNvbnN0IGQgPSBuZXcgRGF0ZSh0aW1lKTtcblxuICAgIGxldCBkYXlzID0gZC5nZXREYXRlKCk7XG4gICAgZGF5cyA9IGRheXMgPiA5ID8gZGF5cyA6ICcwJyArIGRheXM7XG5cbiAgICBsZXQgbW9udGhzID0gZC5nZXRNb250aCgpKzE7XG4gICAgbW9udGhzID0gbW9udGhzID4gOSA/IG1vbnRocyA6ICcwJyArIG1vbnRocztcblxuICAgIGNvbnN0IHllYXIgPSBkLmdldEZ1bGxZZWFyKCk7XG5cbiAgICBjb25zdCBmb3JtYXRlZERhdGUgPSBkYXlzICsgJy4nICsgbW9udGhzICsgJy4nICsgeWVhcjtcbiAgICByZXR1cm4gZm9ybWF0ZWREYXRlO1xufVxuZnVuY3Rpb24gcmVtb3ZlUXVlcnkoaWQpIHtcbiAgbGV0IHF1ZXJpZXMgPSB1dGlscy5nZXRMb2NhbFN0b3JhZ2UoKS5nZXRPYmplY3QoJ3JlY2VudFF1ZXJpZXMnLCBbXSk7XG5cbiAgcXVlcmllcyA9IHF1ZXJpZXMuZmlsdGVyKHF1ZXJ5ID0+IGlkICE9PSBxdWVyeS5pZCk7XG4gIHV0aWxzLmdldExvY2FsU3RvcmFnZSgpLnNldE9iamVjdCgncmVjZW50UXVlcmllcycsIHF1ZXJpZXMpO1xufVxuXG5mdW5jdGlvbiByZW1vdmVIaXN0b3J5SXRlbShpZCkge1xuICBhbGxIaXN0b3J5ID0gYWxsSGlzdG9yeS5maWx0ZXIoaGlzdG9yeSA9PiBpZCAhPT0gaGlzdG9yeS5pZCk7XG4gIG9zQVBJLnJlbW92ZUhpc3RvcnlJdGVtcyhbaWRdKTtcbn1cblxuZnVuY3Rpb24gcmVtb3ZlSXRlbShpdGVtKSB7XG4gIGNvbnN0IGlkID0gcGFyc2VJbnQoaXRlbS5kYXRhc2V0LmlkKTtcbiAgaXRlbS5nZXRBdHRyaWJ1dGUoJ2NsYXNzJykuaW5kZXhPZigncXVlc3Rpb24nKSA+PSAwID8gcmVtb3ZlUXVlcnkoaWQpIDogcmVtb3ZlSGlzdG9yeUl0ZW0oaWQpO1xufVxuXG5mdW5jdGlvbiB1bmZhdm9yaXRlSXRlbShpdGVtKSB7XG4gIGNvbnN0IHVybCA9IGl0ZW0uZ2V0QXR0cmlidXRlKCdkYXRhJyk7XG4gIGNvbnN0IHRpdGxlID0gaXRlbS5kYXRhc2V0LnRpdGxlO1xuICBvc0FQSS5zZXRGYXZvcml0ZXMoW3t0aXRsZSwgdXJsfV0sIGZhbHNlKTtcbn1cblxuZnVuY3Rpb24gaW5pdChvbmx5RmF2b3JpdGVzKSB7XG4gIG1pZ3JhdGVRdWVyaWVzKCk7XG4gIEhpc3Rvcnkuc2hvd09ubHlGYXZvcml0ZSA9IG9ubHlGYXZvcml0ZXM7XG4gIHN1YnNjcmliZUV2ZW50cygpO1xuICB1cGRhdGUoKTtcbn1cblxuZnVuY3Rpb24gdXBkYXRlKCkge1xuICBjb25zdCBjYWxsYmFjayA9IEhpc3Rvcnkuc2hvd09ubHlGYXZvcml0ZSA/IHNob3dGYXZvcml0ZXMgOiBzaG93SGlzdG9yeTtcbiAgaGlzdG9yeVRpbWVyID0gc2V0VGltZW91dChjYWxsYmFjaywgNTAwLCBbXSk7XG4gIEhpc3Rvcnkuc2hvd09ubHlGYXZvcml0ZSA/IG9zQVBJLmdldEZhdm9yaXRlcygnSGlzdG9yeS5zaG93RmF2b3JpdGVzJykgOiBvc0FQSS5nZXRIaXN0b3J5SXRlbXMoJ0hpc3Rvcnkuc2hvd0hpc3RvcnknKTtcbn1cblxuZnVuY3Rpb24gY2xlYXJIaXN0b3J5KCkge1xuICB1dGlscy5nZXRMb2NhbFN0b3JhZ2UoKS5zZXRPYmplY3QoJ3JlY2VudFF1ZXJpZXMnLCBbXSk7XG59XG5cbmZ1bmN0aW9uIGNsZWFyRmF2b3JpdGVzKCkge1xuICB1dGlscy5nZXRMb2NhbFN0b3JhZ2UoKS5zZXRPYmplY3QoJ2Zhdm9yaXRlUXVlcmllcycsIFtdKTtcbn1cblxuZnVuY3Rpb24gb25FbGVtZW50Q2xpY2soZXZlbnQpIHtcbiAgY29uc3QgZWxlbWVudCA9IGV2ZW50LnNyY0V2ZW50LmN1cnJlbnRUYXJnZXQ7XG4gIGNvbnN0IHR5cGUgPSBlbGVtZW50LmdldEF0dHJpYnV0ZSgnY2xhc3MnKTtcbiAgY29uc3QgY2xpY2tBY3Rpb24gPSB0eXBlLmluZGV4T2YoJ3F1ZXN0aW9uJykgPj0gMCA/IG9zQVBJLm5vdGlmeVF1ZXJ5IDogb3NBUEkub3Blbkxpbms7XG4gIGNsaWNrQWN0aW9uKGVsZW1lbnQuZ2V0QXR0cmlidXRlKCdkYXRhJykpO1xuICBzZW5kQ2xpY2tUZWxlbWV0cnkoZWxlbWVudCk7XG59XG5cbmZ1bmN0aW9uIHNlbmRDbGlja1RlbGVtZXRyeShlbGVtZW50KSB7XG4gIGNvbnN0IHRhcmdlVHlwZSA9IGVsZW1lbnQuY2xhc3NOYW1lLmluZGV4T2YoJ3F1ZXN0aW9uJykgPj0gMCA/ICdxdWVyeScgOiAndXJsJztcbiAgICB1dGlscy50ZWxlbWV0cnkoe1xuICAgICAgdHlwZTogSGlzdG9yeS5zaG93T25seUZhdm9yaXRlID8gJ2Zhdm9yaXRlcycgOiAnaGlzdG9yeScsXG4gICAgICBhY3Rpb246ICdjbGljaycsXG4gICAgICB0YXJnZXRfdHlwZTogdGFyZ2VUeXBlLFxuICAgICAgdGFyZ2V0X2luZGV4OiBwYXJzZUludChlbGVtZW50LmRhdGFzZXQuaW5kZXgpLFxuICAgICAgdGFyZ2V0X2xlbmd0aDogZWxlbWVudC5nZXRBdHRyaWJ1dGUoJ2RhdGEnKS5sZW5ndGgsXG4gICAgICB0YXJnZXRfdHM6IHBhcnNlSW50KGVsZW1lbnQuZGF0YXNldC50aW1lc3RhbXApXG4gICAgfSk7XG59XG5cbmZ1bmN0aW9uIGNyb3NzVHJhbnNmb3JtIChlbGVtZW50LCB4KSB7XG4gIHZhciBwbGF0Zm9ybXMgPSBbJycsICctd2Via2l0LScsICctbXMtJ107XG4gIHBsYXRmb3Jtcy5mb3JFYWNoKGZ1bmN0aW9uIChwbGF0Zm9ybSkge1xuICAgIGVsZW1lbnQuc3R5bGVbcGxhdGZvcm0gKyAndHJhbnNmb3JtJ10gPSAndHJhbnNsYXRlM2QoJysgeCArJ3B4LCAwcHgsIDBweCknO1xuICB9KTtcbn1cblxuZnVuY3Rpb24gaXNFbGVtZW50RGF0ZShlbGVtZW50KSB7XG4gIHJldHVybiAhZWxlbWVudC5kYXRhc2V0LnRpbWVzdGFtcFxufVxuXG5mdW5jdGlvbiBhdHRhY2hMaXN0ZW5lcnMobGlzdCkge1xuICB2YXIgbGlzdEl0ZW1zID0gbGlzdC5nZXRFbGVtZW50c0J5VGFnTmFtZShcImxpXCIpO1xuXG4gIGZvciAobGV0IGkgPSAwOyBpIDwgbGlzdEl0ZW1zLmxlbmd0aDsgaSsrKSB7XG4gICAgaWYoIWlzRWxlbWVudERhdGUobGlzdEl0ZW1zW2ldKSkge1xuICAgICAgbmV3IEhhbW1lcihsaXN0SXRlbXNbaV0pLm9uKCdwYW4nLCBvblN3aXBlKTtcbiAgICAgIG5ldyBIYW1tZXIobGlzdEl0ZW1zW2ldKS5vbigncGFuZW5kJywgb25Td2lwZUVuZCk7XG4gICAgICBuZXcgSGFtbWVyKGxpc3RJdGVtc1tpXSkub24oJ3RhcCcsIG9uRWxlbWVudENsaWNrKTtcbiAgICB9XG4gIH1cbn1cblxuZnVuY3Rpb24gcmVtb3ZlRG9tRWxlbWVudChlbGVtZW50KSB7XG4gIGNvbnN0IHByZXYgPSBlbGVtZW50LnByZXZpb3VzRWxlbWVudFNpYmxpbmc7XG4gIGNvbnN0IG5leHQgPSBlbGVtZW50Lm5leHRFbGVtZW50U2libGluZztcbiAgaWYgKHByZXYgJiYgaXNFbGVtZW50RGF0ZShwcmV2KSkge1xuICAgIGlmICghbmV4dCB8fCBpc0VsZW1lbnREYXRlKG5leHQpKSB7XG4gICAgICBlbGVtZW50LnBhcmVudEVsZW1lbnQucmVtb3ZlQ2hpbGQocHJldik7XG4gICAgfVxuICB9XG4gIGVsZW1lbnQucGFyZW50RWxlbWVudC5yZW1vdmVDaGlsZChlbGVtZW50KTtcbn1cblxuZnVuY3Rpb24gb25Td2lwZShlKSB7XG4gIGNyb3NzVHJhbnNmb3JtKGUuc3JjRXZlbnQuY3VycmVudFRhcmdldCwgZS5kZWx0YVgpO1xufVxuZnVuY3Rpb24gb25Td2lwZUVuZChlKSB7XG4gIGNvbnN0IGVsZW1lbnQgPSBlLnNyY0V2ZW50LmN1cnJlbnRUYXJnZXQ7XG4gIGlmIChtYXRoLmFicyhlLnZlbG9jaXR5WCkgPCAtMSB8fCBtYXRoLmFicyhlLmRlbHRhWCkgPiAxNTApIHtcbiAgICBIaXN0b3J5LnNob3dPbmx5RmF2b3JpdGUgPyB1bmZhdm9yaXRlSXRlbShlbGVtZW50KSA6IHJlbW92ZUl0ZW0oZWxlbWVudCk7XG4gICAgcmVtb3ZlRG9tRWxlbWVudChlbGVtZW50KTtcbiAgfSBlbHNlIHtcbiAgICBjcm9zc1RyYW5zZm9ybShlbGVtZW50LCAwKTtcbiAgfVxufVxuXG5cbi8qKlxuICBUaGlzIGZ1bmN0aW9uIGlzIGZvciBtaWdyYXRpb24gb2YgaGlzdG9yeSBhbmQgZmF2b3JpdGUgcXVlcmllc1xuICB0byBleHRlbnNpb24gdmVyc2lvbiBNb2JpbGUgRXh0ZW5zaW9uIDMuNS4yXG4qKi9cbmZ1bmN0aW9uIG1pZ3JhdGVRdWVyaWVzKCkge1xuICBpZiAodXRpbHMuZ2V0TG9jYWxTdG9yYWdlKCkuZ2V0SXRlbSgnaXNGYXZvcml0ZXNSZWZhY3RvcmVkJykpIHtcbiAgICByZXR1cm47XG4gIH1cbiAgbGV0IHF1ZXJpZXMgPSB1dGlscy5nZXRMb2NhbFN0b3JhZ2UoKS5nZXRPYmplY3QoJ3JlY2VudFF1ZXJpZXMnLCBbXSk7XG4gIGxldCBmYXZvcml0ZVF1ZXJpZXMgPSB1dGlscy5nZXRMb2NhbFN0b3JhZ2UoKS5nZXRPYmplY3QoJ2Zhdm9yaXRlUXVlcmllcycsIFtdKTtcbiAgcXVlcmllcyA9IHF1ZXJpZXMubWFwKHF1ZXJ5ID0+IHtcbiAgICBpZiAocXVlcnkuZmF2b3JpdGUpIHtcbiAgICAgIGZhdm9yaXRlUXVlcmllcy51bnNoaWZ0KHtxdWVyeTogcXVlcnkucXVlcnksIHRpbWVzdGFtcDogcXVlcnkudGltZXN0YW1wfSk7XG4gICAgfVxuICAgIGRlbGV0ZSBxdWVyeS5mYXZvcml0ZTtcbiAgICByZXR1cm4gcXVlcnk7XG4gIH0pO1xuICB1dGlscy5nZXRMb2NhbFN0b3JhZ2UoKS5zZXRPYmplY3QoJ3JlY2VudFF1ZXJpZXMnLCBxdWVyaWVzKTtcbiAgdXRpbHMuZ2V0TG9jYWxTdG9yYWdlKCkuc2V0T2JqZWN0KCdmYXZvcml0ZVF1ZXJpZXMnLCBmYXZvcml0ZVF1ZXJpZXMpO1xuICB1dGlscy5nZXRMb2NhbFN0b3JhZ2UoKS5zZXRJdGVtKCdpc0Zhdm9yaXRlc1JlZmFjdG9yZWQnLCB0cnVlKTtcbn1cblxuZnVuY3Rpb24gc3Vic2NyaWJlRXZlbnRzKCkge1xuICBDbGlxekV2ZW50cy5zdWIoJ3Nob3cnLCBqc0FQSS5vblNob3cpO1xuICBDbGlxekV2ZW50cy5zdWIoJ2NsZWFyX2Zhdm9yaXRlcycsIGpzQVBJLmNsZWFyRmF2b3JpdGVzKTtcbiAgQ2xpcXpFdmVudHMuc3ViKCdjbGVhcl9oaXN0b3J5JywganNBUEkuY2xlYXJIaXN0b3J5KTtcbn1cblxuXG52YXIgSGlzdG9yeSA9IHtcbiAgaW5pdCxcbiAgdXBkYXRlLFxuICBzaG93SGlzdG9yeSxcbiAgc2hvd0Zhdm9yaXRlcyxcbiAgY2xlYXJIaXN0b3J5LFxuICBjbGVhckZhdm9yaXRlcyxcbiAgZGlzcGxheURhdGEsXG4gIHNlbmRTaG93VGVsZW1ldHJ5LFxuICBzaG93T25seUZhdm9yaXRlOiBmYWxzZVxufTtcblxuZXhwb3J0IGRlZmF1bHQgSGlzdG9yeTsiXX0=