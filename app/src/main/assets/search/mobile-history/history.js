System.register('mobile-history/history', ['core/cliqz'], function (_export) {
  'use strict';
  /* global document, osAPI, Hammer, math */

  var environment, handlebars, utils, historyTimer, allHistory, allFavorites, History;

  function showHistory(history) {
    clearTimeout(historyTimer);

    allHistory = history;
    var queries = environment.getLocalStorage().getObject('recentQueries', []).reverse();

    for (var i = 0; i < history.length; i++) {
      history[i].domain = history[i].url.match(/^(?:https?:\/\/)?(?:www\.)?([^\/]+)/i)[1];
    }

    var historyWithLogos = addLogos(history);
    var data = mixHistoryWithQueries(queries, historyWithLogos);
    History.displayData(data, History.showOnlyFavorite);
  }

  function showFavorites(favorites) {
    clearTimeout(historyTimer);

    allFavorites = favorites;

    for (var i = 0; i < favorites.length; i++) {
      favorites[i].domain = favorites[i].url.match(/^(?:https?:\/\/)?(?:www\.)?([^\/]+)/i)[1];
    }

    var favoritesWithLogos = addLogos(favorites);

    History.displayData(favoritesWithLogos, History.showOnlyFavorite);
  }

  function addLogos(list) {
    return list.map(function (item) {
      var details = utils.getDetailsFromUrl(item.url);
      item.logo = utils.getLogoDetails(details);
      return item;
    });
  }

  function sendShowTelemetry(data) {
    var queryCount = data.filter(function (item) {
      return item.query;
    }).length,
        urlCount = data.filter(function (item) {
      return item.url;
    }).length;
    utils.telemetry({
      type: History.showOnlyFavorite ? 'favorites' : 'history',
      action: 'show',
      active_day_count: data.length - queryCount - urlCount,
      query_count: queryCount,
      url_count: urlCount
    });
  }

  function mixHistoryWithQueries(queries, history) {
    var data = [];
    var hi = 0;
    var qi = 0;
    var date = '';
    while (true) {
      if (hi >= history.length || qi >= queries.length) {
        break;
      }

      if (history[hi].timestamp <= queries[qi].timestamp) {
        if (getDateFromTimestamp(history[hi].timestamp) !== date) {
          data.push({ date: getDateFromTimestamp(history[hi].timestamp) });
          date = getDateFromTimestamp(history[hi].timestamp);
        }
        data.push(history[hi]);

        hi++;
      } else {
        if (getDateFromTimestamp(queries[qi].timestamp) !== date) {
          data.push({ date: getDateFromTimestamp(queries[qi].timestamp) });
          date = getDateFromTimestamp(queries[qi].timestamp);
        }
        data.push(queries[qi]);
        qi++;
      }
    }
    while (hi < history.length) {
      if (getDateFromTimestamp(history[hi].timestamp) !== date) {
        data.push({ date: getDateFromTimestamp(history[hi].timestamp) });
        date = getDateFromTimestamp(history[hi].timestamp);
      }
      data.push(history[hi]);
      hi++;
    }
    while (qi < queries.length) {
      if (getDateFromTimestamp(queries[qi].timestamp) !== date) {
        data.push({ date: getDateFromTimestamp(queries[qi].timestamp) });
        date = getDateFromTimestamp(queries[qi].timestamp);
      }
      data.push(queries[qi]);
      qi++;
    }

    return data;
  }

  function displayData(data) {
    var isFavorite = arguments.length <= 1 || arguments[1] === undefined ? false : arguments[1];

    if (!handlebars.tplCache['conversations']) {
      return setTimeout(History.displayData, 100, data);
    }

    var template = isFavorite ? 'favorites' : 'conversations';
    document.body.innerHTML = handlebars.tplCache[template]({ data: data });

    var B = document.body,
        H = document.documentElement;

    var height = undefined;

    if (typeof document.height !== 'undefined') {
      height = document.height; // For webkit browsers
    } else {
        height = Math.max(B.scrollHeight, B.offsetHeight, H.clientHeight, H.scrollHeight, H.offsetHeight);
      }

    document.body.scrollTop = height + 100;

    attachListeners(document.getElementById('container'));
    History.sendShowTelemetry(data);
  }

  function getDateFromTimestamp(time) {
    var d = new Date(time);

    var days = d.getDate();
    days = days > 9 ? days : '0' + days;

    var months = d.getMonth() + 1;
    months = months > 9 ? months : '0' + months;

    var year = d.getFullYear();

    var formatedDate = days + '.' + months + '.' + year;
    return formatedDate;
  }

  function removeQuery(id) {
    var queries = environment.getLocalStorage().getObject('recentQueries', []);

    queries = queries.filter(function (query) {
      return id !== query.id;
    });
    environment.getLocalStorage().setObject('recentQueries', queries);
  }

  function removeHistoryItem(id) {
    allHistory = allHistory.filter(function (history) {
      return id !== history.id;
    });
    osAPI.removeHistoryItems([id]);
  }

  function removeItem(item) {
    var id = parseInt(item.dataset.id);
    item.getAttribute('class').indexOf('question') >= 0 ? removeQuery(id) : removeHistoryItem(id);
  }

  function unfavoriteItem(item) {
    var url = item.getAttribute('data');
    var title = item.dataset.title;
    osAPI.setFavorites([{ title: title, url: url }], false);
  }

  function init(onlyFavorites) {
    migrateQueries();
    History.showOnlyFavorite = onlyFavorites;
    update();
  }

  function update() {
    var callback = History.showOnlyFavorite ? showFavorites : showHistory;
    historyTimer = setTimeout(callback, 500, []);
    History.showOnlyFavorite ? osAPI.getFavorites('History.showFavorites') : osAPI.getHistoryItems('History.showHistory');
  }

  function clearHistory() {
    environment.getLocalStorage().setObject('recentQueries', []);
  }

  function clearFavorites() {
    environment.getLocalStorage().setObject('favoriteQueries', []);
  }

  function onElementClick(event) {
    var element = event.srcEvent.currentTarget;
    var type = element.getAttribute('class');
    var clickAction = type.indexOf('question') >= 0 ? osAPI.notifyQuery : osAPI.openLink;
    clickAction(element.getAttribute('data'));
    sendClickTelemetry(element);
  }

  function sendClickTelemetry(element) {
    var targeType = element.className.indexOf('question') >= 0 ? 'query' : 'url';
    utils.telemetry({
      type: History.showOnlyFavorite ? 'favorites' : 'history',
      action: 'click',
      target_type: targeType,
      target_index: parseInt(element.dataset.index),
      target_length: element.getAttribute('data').length,
      target_ts: parseInt(element.dataset.timestamp)
    });
  }

  function crossTransform(element, x) {
    var platforms = ['', '-webkit-', '-ms-'];
    platforms.forEach(function (platform) {
      element.style[platform + 'transform'] = 'translate3d(' + x + 'px, 0px, 0px)';
    });
  }

  function isElementDate(element) {
    return !element.dataset.timestamp;
  }

  function attachListeners(list) {
    var listItems = list.getElementsByTagName("li");

    for (var i = 0; i < listItems.length; i++) {
      if (!isElementDate(listItems[i])) {
        new Hammer(listItems[i]).on('pan', onSwipe);
        new Hammer(listItems[i]).on('panend', onSwipeEnd);
        new Hammer(listItems[i]).on('tap', onElementClick);
      }
    }
  }

  function removeDomElement(element) {
    var prev = element.previousElementSibling;
    var next = element.nextElementSibling;
    if (prev && isElementDate(prev)) {
      if (!next || isElementDate(next)) {
        element.parentElement.removeChild(prev);
      }
    }
    element.parentElement.removeChild(element);
  }

  function onSwipe(e) {
    crossTransform(e.srcEvent.currentTarget, math.min(e.deltaX, 0));
  }
  function onSwipeEnd(e) {
    var element = e.srcEvent.currentTarget;
    if (e.velocityX < -0.6 || e.distance > 200 || e.center.x < 50) {
      History.showOnlyFavorite ? unfavoriteItem(element) : removeItem(element);
      removeDomElement(element);
    } else {
      crossTransform(element, 0);
    }
  }

  /**
    This function is for migration of history and favorite queries
    to extension version Mobile Extension 3.5.2
  **/
  function migrateQueries() {
    if (environment.getLocalStorage().getItem('isFavoritesRefactored')) {
      return;
    }
    var queries = environment.getLocalStorage().getObject('recentQueries', []);
    var favoriteQueries = environment.getLocalStorage().getObject('favoriteQueries', []);
    queries = queries.map(function (query) {
      if (query.favorite) {
        favoriteQueries.unshift({ query: query.query, timestamp: query.timestamp });
      }
      delete query.favorite;
      return query;
    });
    environment.getLocalStorage().setObject('recentQueries', queries);
    environment.getLocalStorage().setObject('favoriteQueries', favoriteQueries);
    environment.getLocalStorage().setItem('isFavoritesRefactored', true);
  }

  return {
    setters: [function (_coreCliqz) {
      environment = _coreCliqz.environment;
      handlebars = _coreCliqz.handlebars;
      utils = _coreCliqz.utils;
    }],
    execute: function () {
      allHistory = [];
      allFavorites = [];
      History = {
        init: init,
        update: update,
        showHistory: showHistory,
        showFavorites: showFavorites,
        clearHistory: clearHistory,
        clearFavorites: clearFavorites,
        displayData: displayData,
        sendShowTelemetry: sendShowTelemetry,
        showOnlyFavorite: false
      };

      _export('default', History);
    }
  };
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm1vYmlsZS1oaXN0b3J5L2hpc3RvcnkuZXMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLGNBQVksQ0FBQzs7O3NDQUtULFlBQVksRUFDWixVQUFVLEVBQ1YsWUFBWSxFQWlSWixPQUFPOztBQS9RWCxXQUFTLFdBQVcsQ0FBQyxPQUFPLEVBQUU7QUFDNUIsZ0JBQVksQ0FBQyxZQUFZLENBQUMsQ0FBQzs7QUFFM0IsY0FBVSxHQUFHLE9BQU8sQ0FBQztBQUNyQixRQUFNLE9BQU8sR0FBRyxXQUFXLENBQUMsZUFBZSxFQUFFLENBQUMsU0FBUyxDQUFDLGVBQWUsRUFBRSxFQUFFLENBQUMsQ0FBQyxPQUFPLEVBQUUsQ0FBQzs7QUFFdkYsU0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLE9BQU8sQ0FBQyxNQUFNLEVBQUUsQ0FBQyxFQUFFLEVBQUU7QUFDdkMsYUFBTyxDQUFDLENBQUMsQ0FBQyxDQUFDLE1BQU0sR0FBRyxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxzQ0FBc0MsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO0tBQ3JGOztBQUVELFFBQU0sZ0JBQWdCLEdBQUcsUUFBUSxDQUFDLE9BQU8sQ0FBQyxDQUFDO0FBQzNDLFFBQU0sSUFBSSxHQUFHLHFCQUFxQixDQUFDLE9BQU8sRUFBRSxnQkFBZ0IsQ0FBQyxDQUFDO0FBQzlELFdBQU8sQ0FBQyxXQUFXLENBQUMsSUFBSSxFQUFFLE9BQU8sQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDO0dBQ3JEOztBQUVELFdBQVMsYUFBYSxDQUFDLFNBQVMsRUFBRTtBQUNoQyxnQkFBWSxDQUFDLFlBQVksQ0FBQyxDQUFDOztBQUUzQixnQkFBWSxHQUFHLFNBQVMsQ0FBQzs7QUFFekIsU0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLFNBQVMsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxFQUFFLEVBQUU7QUFDekMsZUFBUyxDQUFDLENBQUMs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eEI7O3lCQUVjLE9BQU8iLCJmaWxlIjoibW9iaWxlLWhpc3RvcnkvaGlzdG9yeS5lcyIsInNvdXJjZXNDb250ZW50IjpbIid1c2Ugc3RyaWN0Jztcbi8qIGdsb2JhbCBkb2N1bWVudCwgb3NBUEksIEhhbW1lciwgbWF0aCAqL1xuXG5pbXBvcnQgeyBlbnZpcm9ubWVudCwgaGFuZGxlYmFycywgdXRpbHMgfSBmcm9tICdjb3JlL2NsaXF6JztcblxudmFyIGhpc3RvcnlUaW1lcjtcbnZhciBhbGxIaXN0b3J5ID0gW107XG52YXIgYWxsRmF2b3JpdGVzID0gW107XG5cbmZ1bmN0aW9uIHNob3dIaXN0b3J5KGhpc3RvcnkpIHtcbiAgY2xlYXJUaW1lb3V0KGhpc3RvcnlUaW1lcik7XG5cbiAgYWxsSGlzdG9yeSA9IGhpc3Rvcnk7XG4gIGNvbnN0IHF1ZXJpZXMgPSBlbnZpcm9ubWVudC5nZXRMb2NhbFN0b3JhZ2UoKS5nZXRPYmplY3QoJ3JlY2VudFF1ZXJpZXMnLCBbXSkucmV2ZXJzZSgpO1xuXG4gIGZvciAobGV0IGkgPSAwOyBpIDwgaGlzdG9yeS5sZW5ndGg7IGkrKykge1xuICAgIGhpc3RvcnlbaV0uZG9tYWluID0gaGlzdG9yeVtpXS51cmwubWF0Y2goL14oPzpodHRwcz86XFwvXFwvKT8oPzp3d3dcXC4pPyhbXlxcL10rKS9pKVsxXTtcbiAgfVxuXG4gIGNvbnN0IGhpc3RvcnlXaXRoTG9nb3MgPSBhZGRMb2dvcyhoaXN0b3J5KTtcbiAgY29uc3QgZGF0YSA9IG1peEhpc3RvcnlXaXRoUXVlcmllcyhxdWVyaWVzLCBoaXN0b3J5V2l0aExvZ29zKTtcbiAgSGlzdG9yeS5kaXNwbGF5RGF0YShkYXRhLCBIaXN0b3J5LnNob3dPbmx5RmF2b3JpdGUpO1xufVxuXG5mdW5jdGlvbiBzaG93RmF2b3JpdGVzKGZhdm9yaXRlcykge1xuICBjbGVhclRpbWVvdXQoaGlzdG9yeVRpbWVyKTtcblxuICBhbGxGYXZvcml0ZXMgPSBmYXZvcml0ZXM7XG5cbiAgZm9yIChsZXQgaSA9IDA7IGkgPCBmYXZvcml0ZXMubGVuZ3RoOyBpKyspIHtcbiAgICBmYXZvcml0ZXNbaV0uZG9tYWluID0gZmF2b3JpdGVzW2ldLnVybC5tYXRjaCgvXig/Omh0dHBzPzpcXC9cXC8pPyg/Ond3d1xcLik/KFteXFwvXSspL2kpWzFdO1xuICB9XG5cbiAgY29uc3QgZmF2b3JpdGVzV2l0aExvZ29zID0gYWRkTG9nb3MoZmF2b3JpdGVzKTtcblxuICBIaXN0b3J5LmRpc3BsYXlEYXRhKGZhdm9yaXRlc1dpdGhMb2dvcywgSGlzdG9yeS5zaG93T25seUZhdm9yaXRlKTtcbn1cblxuZnVuY3Rpb24gYWRkTG9nb3MobGlzdCkge1xuICByZXR1cm4gbGlzdC5tYXAoaXRlbSA9PiB7XG4gICAgY29uc3QgZGV0YWlscyA9IHV0aWxzLmdldERldGFpbHNGcm9tVXJsKGl0ZW0udXJsKTtcbiAgICBpdGVtLmxvZ28gPSB1dGlscy5nZXRMb2dvRGV0YWlscyhkZXRhaWxzKTtcbiAgICByZXR1cm4gaXRlbTtcbiAgfSk7XG59XG5cbmZ1bmN0aW9uIHNlbmRTaG93VGVsZW1ldHJ5KGRhdGEpIHtcbiAgY29uc3QgcXVlcnlDb3VudCA9IGRhdGEuZmlsdGVyKGZ1bmN0aW9uIChpdGVtKSB7IHJldHVybiBpdGVtLnF1ZXJ5OyB9KS5sZW5ndGgsXG4gICAgICB1cmxDb3VudCA9IGRhdGEuZmlsdGVyKGZ1bmN0aW9uIChpdGVtKSB7IHJldHVybiBpdGVtLnVybDsgfSkubGVuZ3RoO1xuICB1dGlscy50ZWxlbWV0cnkoe1xuICAgIHR5cGU6IEhpc3Rvcnkuc2hvd09ubHlGYXZvcml0ZSA/ICdmYXZvcml0ZXMnIDogJ2hpc3RvcnknLFxuICAgIGFjdGlvbjogJ3Nob3cnLFxuICAgIGFjdGl2ZV9kYXlfY291bnQ6IGRhdGEubGVuZ3RoIC0gcXVlcnlDb3VudCAtIHVybENvdW50LFxuICAgIHF1ZXJ5X2NvdW50OiBxdWVyeUNvdW50LFxuICAgIHVybF9jb3VudDogdXJsQ291bnRcbiAgfSk7XG59XG5cblxuZnVuY3Rpb24gbWl4SGlzdG9yeVdpdGhRdWVyaWVzKHF1ZXJpZXMsIGhpc3RvcnkpIHtcbiAgbGV0IGRhdGEgPSBbXTtcbiAgbGV0IGhpID0gMDtcbiAgbGV0IHFpID0gMDtcbiAgbGV0IGRhdGUgPSAnJztcbiAgd2hpbGUgKHRydWUpIHtcbiAgICBpZiAoaGkgPj0gaGlzdG9yeS5sZW5ndGggfHwgcWkgPj0gcXVlcmllcy5sZW5ndGgpIHtcbiAgICAgIGJyZWFrO1xuICAgIH1cblxuICAgIGlmIChoaXN0b3J5W2hpXS50aW1lc3RhbXAgPD0gcXVlcmllc1txaV0udGltZXN0YW1wKSB7XG4gICAgICBpZiAoZ2V0RGF0ZUZyb21UaW1lc3RhbXAoaGlzdG9yeVtoaV0udGltZXN0YW1wKSAhPT0gZGF0ZSkge1xuICAgICAgICBkYXRhLnB1c2goe2RhdGU6IGdldERhdGVGcm9tVGltZXN0YW1wKGhpc3RvcnlbaGldLnRpbWVzdGFtcCl9KTtcbiAgICAgICAgZGF0ZSA9IGdldERhdGVGcm9tVGltZXN0YW1wKGhpc3RvcnlbaGldLnRpbWVzdGFtcCk7XG4gICAgICB9XG4gICAgICBkYXRhLnB1c2goaGlzdG9yeVtoaV0pO1xuXG4gICAgICBoaSsrO1xuICAgIH0gZWxzZSB7XG4gICAgICBpZiAoZ2V0RGF0ZUZyb21UaW1lc3RhbXAocXVlcmllc1txaV0udGltZXN0YW1wKSAhPT0gZGF0ZSkge1xuICAgICAgICBkYXRhLnB1c2goe2RhdGU6IGdldERhdGVGcm9tVGltZXN0YW1wKHF1ZXJpZXNbcWldLnRpbWVzdGFtcCl9KTtcbiAgICAgICAgZGF0ZSA9IGdldERhdGVGcm9tVGltZXN0YW1wKHF1ZXJpZXNbcWldLnRpbWVzdGFtcCk7XG4gICAgICB9XG4gICAgICBkYXRhLnB1c2gocXVlcmllc1txaV0pO1xuICAgICAgcWkrKztcbiAgICB9XG4gIH1cbiAgd2hpbGUgKGhpIDwgaGlzdG9yeS5sZW5ndGgpIHtcbiAgICBpZiAoZ2V0RGF0ZUZyb21UaW1lc3RhbXAoaGlzdG9yeVtoaV0udGltZXN0YW1wKSAhPT0gZGF0ZSkge1xuICAgICAgZGF0YS5wdXNoKHtkYXRlOiBnZXREYXRlRnJvbVRpbWVzdGFtcChoaXN0b3J5W2hpXS50aW1lc3RhbXApfSk7XG4gICAgICBkYXRlID0gZ2V0RGF0ZUZyb21UaW1lc3RhbXAoaGlzdG9yeVtoaV0udGltZXN0YW1wKTtcbiAgICB9XG4gICAgZGF0YS5wdXNoKGhpc3RvcnlbaGldKTtcbiAgICBoaSsrO1xuICB9XG4gIHdoaWxlIChxaSA8IHF1ZXJpZXMubGVuZ3RoKSB7XG4gICAgaWYgKGdldERhdGVGcm9tVGltZXN0YW1wKHF1ZXJpZXNbcWldLnRpbWVzdGFtcCkgIT09IGRhdGUpIHtcbiAgICAgIGRhdGEucHVzaCh7ZGF0ZTogZ2V0RGF0ZUZyb21UaW1lc3RhbXAocXVlcmllc1txaV0udGltZXN0YW1wKX0pO1xuICAgICAgZGF0ZSA9IGdldERhdGVGcm9tVGltZXN0YW1wKHF1ZXJpZXNbcWldLnRpbWVzdGFtcCk7XG4gICAgfVxuICAgIGRhdGEucHVzaChxdWVyaWVzW3FpXSk7XG4gICAgcWkrKztcbiAgfVxuXG4gIHJldHVybiBkYXRhO1xufVxuXG5mdW5jdGlvbiBkaXNwbGF5RGF0YShkYXRhLCBpc0Zhdm9yaXRlID0gZmFsc2UpIHtcbiAgaWYgKCFoYW5kbGViYXJzLnRwbENhY2hlWydjb252ZXJzYXRpb25zJ10pIHtcbiAgICByZXR1cm4gc2V0VGltZW91dChIaXN0b3J5LmRpc3BsYXlEYXRhLCAxMDAsIGRhdGEpO1xuICB9XG5cbiAgY29uc3QgdGVtcGxhdGUgPSBpc0Zhdm9yaXRlID8gJ2Zhdm9yaXRlcycgOiAnY29udmVyc2F0aW9ucyc7XG4gIGRvY3VtZW50LmJvZHkuaW5uZXJIVE1MID0gaGFuZGxlYmFycy50cGxDYWNoZVt0ZW1wbGF0ZV0oe2RhdGE6IGRhdGF9KTtcblxuICBjb25zdCBCID0gZG9jdW1lbnQuYm9keSxcbiAgICAgIEggPSBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQ7XG5cbiAgbGV0IGhlaWdodDtcblxuICBpZiAodHlwZW9mIGRvY3VtZW50LmhlaWdodCAhPT0gJ3VuZGVmaW5lZCcpIHtcbiAgICAgIGhlaWdodCA9IGRvY3VtZW50LmhlaWdodDsgLy8gRm9yIHdlYmtpdCBicm93c2Vyc1xuICB9IGVsc2Uge1xuICAgICAgaGVpZ2h0ID0gTWF0aC5tYXgoIEIuc2Nyb2xsSGVpZ2h0LCBCLm9mZnNldEhlaWdodCxILmNsaWVudEhlaWdodCwgSC5zY3JvbGxIZWlnaHQsIEgub2Zmc2V0SGVpZ2h0ICk7XG4gIH1cblxuICBkb2N1bWVudC5ib2R5LnNjcm9sbFRvcCA9IGhlaWdodCArIDEwMDtcblxuICBhdHRhY2hMaXN0ZW5lcnMoZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2NvbnRhaW5lcicpKTtcbiAgSGlzdG9yeS5zZW5kU2hvd1RlbGVtZXRyeShkYXRhKTtcbn1cblxuZnVuY3Rpb24gZ2V0RGF0ZUZyb21UaW1lc3RhbXAodGltZSkge1xuICAgIGNvbnN0IGQgPSBuZXcgRGF0ZSh0aW1lKTtcblxuICAgIGxldCBkYXlzID0gZC5nZXREYXRlKCk7XG4gICAgZGF5cyA9IGRheXMgPiA5ID8gZGF5cyA6ICcwJyArIGRheXM7XG5cbiAgICBsZXQgbW9udGhzID0gZC5nZXRNb250aCgpKzE7XG4gICAgbW9udGhzID0gbW9udGhzID4gOSA/IG1vbnRocyA6ICcwJyArIG1vbnRocztcblxuICAgIGNvbnN0IHllYXIgPSBkLmdldEZ1bGxZZWFyKCk7XG5cbiAgICBjb25zdCBmb3JtYXRlZERhdGUgPSBkYXlzICsgJy4nICsgbW9udGhzICsgJy4nICsgeWVhcjtcbiAgICByZXR1cm4gZm9ybWF0ZWREYXRlO1xufVxuXG5mdW5jdGlvbiByZW1vdmVRdWVyeShpZCkge1xuICBsZXQgcXVlcmllcyA9IGVudmlyb25tZW50LmdldExvY2FsU3RvcmFnZSgpLmdldE9iamVjdCgncmVjZW50UXVlcmllcycsIFtdKTtcblxuICBxdWVyaWVzID0gcXVlcmllcy5maWx0ZXIocXVlcnkgPT4gaWQgIT09IHF1ZXJ5LmlkKTtcbiAgZW52aXJvbm1lbnQuZ2V0TG9jYWxTdG9yYWdlKCkuc2V0T2JqZWN0KCdyZWNlbnRRdWVyaWVzJywgcXVlcmllcyk7XG59XG5cbmZ1bmN0aW9uIHJlbW92ZUhpc3RvcnlJdGVtKGlkKSB7XG4gIGFsbEhpc3RvcnkgPSBhbGxIaXN0b3J5LmZpbHRlcihoaXN0b3J5ID0+IGlkICE9PSBoaXN0b3J5LmlkKTtcbiAgb3NBUEkucmVtb3ZlSGlzdG9yeUl0ZW1zKFtpZF0pO1xufVxuXG5mdW5jdGlvbiByZW1vdmVJdGVtKGl0ZW0pIHtcbiAgY29uc3QgaWQgPSBwYXJzZUludChpdGVtLmRhdGFzZXQuaWQpO1xuICBpdGVtLmdldEF0dHJpYnV0ZSgnY2xhc3MnKS5pbmRleE9mKCdxdWVzdGlvbicpID49IDAgPyByZW1vdmVRdWVyeShpZCkgOiByZW1vdmVIaXN0b3J5SXRlbShpZCk7XG59XG5cbmZ1bmN0aW9uIHVuZmF2b3JpdGVJdGVtKGl0ZW0pIHtcbiAgY29uc3QgdXJsID0gaXRlbS5nZXRBdHRyaWJ1dGUoJ2RhdGEnKTtcbiAgY29uc3QgdGl0bGUgPSBpdGVtLmRhdGFzZXQudGl0bGU7XG4gIG9zQVBJLnNldEZhdm9yaXRlcyhbe3RpdGxlLCB1cmx9XSwgZmFsc2UpO1xufVxuXG5mdW5jdGlvbiBpbml0KG9ubHlGYXZvcml0ZXMpIHtcbiAgbWlncmF0ZVF1ZXJpZXMoKTtcbiAgSGlzdG9yeS5zaG93T25seUZhdm9yaXRlID0gb25seUZhdm9yaXRlcztcbiAgdXBkYXRlKCk7XG59XG5cbmZ1bmN0aW9uIHVwZGF0ZSgpIHtcbiAgY29uc3QgY2FsbGJhY2sgPSBIaXN0b3J5LnNob3dPbmx5RmF2b3JpdGUgPyBzaG93RmF2b3JpdGVzIDogc2hvd0hpc3Rvcnk7XG4gIGhpc3RvcnlUaW1lciA9IHNldFRpbWVvdXQoY2FsbGJhY2ssIDUwMCwgW10pO1xuICBIaXN0b3J5LnNob3dPbmx5RmF2b3JpdGUgPyBvc0FQSS5nZXRGYXZvcml0ZXMoJ0hpc3Rvcnkuc2hvd0Zhdm9yaXRlcycpIDogb3NBUEkuZ2V0SGlzdG9yeUl0ZW1zKCdIaXN0b3J5LnNob3dIaXN0b3J5Jyk7XG59XG5cbmZ1bmN0aW9uIGNsZWFySGlzdG9yeSgpIHtcbiAgZW52aXJvbm1lbnQuZ2V0TG9jYWxTdG9yYWdlKCkuc2V0T2JqZWN0KCdyZWNlbnRRdWVyaWVzJywgW10pO1xufVxuXG5mdW5jdGlvbiBjbGVhckZhdm9yaXRlcygpIHtcbiAgZW52aXJvbm1lbnQuZ2V0TG9jYWxTdG9yYWdlKCkuc2V0T2JqZWN0KCdmYXZvcml0ZVF1ZXJpZXMnLCBbXSk7XG59XG5cbmZ1bmN0aW9uIG9uRWxlbWVudENsaWNrKGV2ZW50KSB7XG4gIGNvbnN0IGVsZW1lbnQgPSBldmVudC5zcmNFdmVudC5jdXJyZW50VGFyZ2V0O1xuICBjb25zdCB0eXBlID0gZWxlbWVudC5nZXRBdHRyaWJ1dGUoJ2NsYXNzJyk7XG4gIGNvbnN0IGNsaWNrQWN0aW9uID0gdHlwZS5pbmRleE9mKCdxdWVzdGlvbicpID49IDAgPyBvc0FQSS5ub3RpZnlRdWVyeSA6IG9zQVBJLm9wZW5MaW5rO1xuICBjbGlja0FjdGlvbihlbGVtZW50LmdldEF0dHJpYnV0ZSgnZGF0YScpKTtcbiAgc2VuZENsaWNrVGVsZW1ldHJ5KGVsZW1lbnQpO1xufVxuXG5mdW5jdGlvbiBzZW5kQ2xpY2tUZWxlbWV0cnkoZWxlbWVudCkge1xuICBjb25zdCB0YXJnZVR5cGUgPSBlbGVtZW50LmNsYXNzTmFtZS5pbmRleE9mKCdxdWVzdGlvbicpID49IDAgPyAncXVlcnknIDogJ3VybCc7XG4gICAgdXRpbHMudGVsZW1ldHJ5KHtcbiAgICAgIHR5cGU6IEhpc3Rvcnkuc2hvd09ubHlGYXZvcml0ZSA/ICdmYXZvcml0ZXMnIDogJ2hpc3RvcnknLFxuICAgICAgYWN0aW9uOiAnY2xpY2snLFxuICAgICAgdGFyZ2V0X3R5cGU6IHRhcmdlVHlwZSxcbiAgICAgIHRhcmdldF9pbmRleDogcGFyc2VJbnQoZWxlbWVudC5kYXRhc2V0LmluZGV4KSxcbiAgICAgIHRhcmdldF9sZW5ndGg6IGVsZW1lbnQuZ2V0QXR0cmlidXRlKCdkYXRhJykubGVuZ3RoLFxuICAgICAgdGFyZ2V0X3RzOiBwYXJzZUludChlbGVtZW50LmRhdGFzZXQudGltZXN0YW1wKVxuICAgIH0pO1xufVxuXG5mdW5jdGlvbiBjcm9zc1RyYW5zZm9ybSAoZWxlbWVudCwgeCkge1xuICB2YXIgcGxhdGZvcm1zID0gWycnLCAnLXdlYmtpdC0nLCAnLW1zLSddO1xuICBwbGF0Zm9ybXMuZm9yRWFjaChmdW5jdGlvbiAocGxhdGZvcm0pIHtcbiAgICBlbGVtZW50LnN0eWxlW3BsYXRmb3JtICsgJ3RyYW5zZm9ybSddID0gJ3RyYW5zbGF0ZTNkKCcrIHggKydweCwgMHB4LCAwcHgpJztcbiAgfSk7XG59XG5cbmZ1bmN0aW9uIGlzRWxlbWVudERhdGUoZWxlbWVudCkge1xuICByZXR1cm4gIWVsZW1lbnQuZGF0YXNldC50aW1lc3RhbXBcbn1cblxuZnVuY3Rpb24gYXR0YWNoTGlzdGVuZXJzKGxpc3QpIHtcbiAgdmFyIGxpc3RJdGVtcyA9IGxpc3QuZ2V0RWxlbWVudHNCeVRhZ05hbWUoXCJsaVwiKTtcblxuICBmb3IgKGxldCBpID0gMDsgaSA8IGxpc3RJdGVtcy5sZW5ndGg7IGkrKykge1xuICAgIGlmKCFpc0VsZW1lbnREYXRlKGxpc3RJdGVtc1tpXSkpIHtcbiAgICAgIG5ldyBIYW1tZXIobGlzdEl0ZW1zW2ldKS5vbigncGFuJywgb25Td2lwZSk7XG4gICAgICBuZXcgSGFtbWVyKGxpc3RJdGVtc1tpXSkub24oJ3BhbmVuZCcsIG9uU3dpcGVFbmQpO1xuICAgICAgbmV3IEhhbW1lcihsaXN0SXRlbXNbaV0pLm9uKCd0YXAnLCBvbkVsZW1lbnRDbGljayk7XG4gICAgfVxuICB9XG59XG5cbmZ1bmN0aW9uIHJlbW92ZURvbUVsZW1lbnQoZWxlbWVudCkge1xuICBjb25zdCBwcmV2ID0gZWxlbWVudC5wcmV2aW91c0VsZW1lbnRTaWJsaW5nO1xuICBjb25zdCBuZXh0ID0gZWxlbWVudC5uZXh0RWxlbWVudFNpYmxpbmc7XG4gIGlmIChwcmV2ICYmIGlzRWxlbWVudERhdGUocHJldikpIHtcbiAgICBpZiAoIW5leHQgfHwgaXNFbGVtZW50RGF0ZShuZXh0KSkge1xuICAgICAgZWxlbWVudC5wYXJlbnRFbGVtZW50LnJlbW92ZUNoaWxkKHByZXYpO1xuICAgIH1cbiAgfVxuICBlbGVtZW50LnBhcmVudEVsZW1lbnQucmVtb3ZlQ2hpbGQoZWxlbWVudCk7XG59XG5cbmZ1bmN0aW9uIG9uU3dpcGUoZSkge1xuICBjcm9zc1RyYW5zZm9ybShlLnNyY0V2ZW50LmN1cnJlbnRUYXJnZXQsIG1hdGgubWluKGUuZGVsdGFYLCAwKSk7XG59XG5mdW5jdGlvbiBvblN3aXBlRW5kKGUpIHtcbiAgY29uc3QgZWxlbWVudCA9IGUuc3JjRXZlbnQuY3VycmVudFRhcmdldDtcbiAgaWYgKGUudmVsb2NpdHlYIDwgLTAuNiB8fCBlLmRpc3RhbmNlID4gMjAwIHx8IGUuY2VudGVyLnggPCA1MCkge1xuICAgIEhpc3Rvcnkuc2hvd09ubHlGYXZvcml0ZSA/IHVuZmF2b3JpdGVJdGVtKGVsZW1lbnQpIDogcmVtb3ZlSXRlbShlbGVtZW50KTtcbiAgICByZW1vdmVEb21FbGVtZW50KGVsZW1lbnQpO1xuICB9IGVsc2Uge1xuICAgIGNyb3NzVHJhbnNmb3JtKGVsZW1lbnQsIDApO1xuICB9XG59XG5cblxuLyoqXG4gIFRoaXMgZnVuY3Rpb24gaXMgZm9yIG1pZ3JhdGlvbiBvZiBoaXN0b3J5IGFuZCBmYXZvcml0ZSBxdWVyaWVzXG4gIHRvIGV4dGVuc2lvbiB2ZXJzaW9uIE1vYmlsZSBFeHRlbnNpb24gMy41LjJcbioqL1xuZnVuY3Rpb24gbWlncmF0ZVF1ZXJpZXMoKSB7XG4gIGlmIChlbnZpcm9ubWVudC5nZXRMb2NhbFN0b3JhZ2UoKS5nZXRJdGVtKCdpc0Zhdm9yaXRlc1JlZmFjdG9yZWQnKSkge1xuICAgIHJldHVybjtcbiAgfVxuICBsZXQgcXVlcmllcyA9IGVudmlyb25tZW50LmdldExvY2FsU3RvcmFnZSgpLmdldE9iamVjdCgncmVjZW50UXVlcmllcycsIFtdKTtcbiAgbGV0IGZhdm9yaXRlUXVlcmllcyA9IGVudmlyb25tZW50LmdldExvY2FsU3RvcmFnZSgpLmdldE9iamVjdCgnZmF2b3JpdGVRdWVyaWVzJywgW10pO1xuICBxdWVyaWVzID0gcXVlcmllcy5tYXAocXVlcnkgPT4ge1xuICAgIGlmIChxdWVyeS5mYXZvcml0ZSkge1xuICAgICAgZmF2b3JpdGVRdWVyaWVzLnVuc2hpZnQoe3F1ZXJ5OiBxdWVyeS5xdWVyeSwgdGltZXN0YW1wOiBxdWVyeS50aW1lc3RhbXB9KTtcbiAgICB9XG4gICAgZGVsZXRlIHF1ZXJ5LmZhdm9yaXRlO1xuICAgIHJldHVybiBxdWVyeTtcbiAgfSk7XG4gIGVudmlyb25tZW50LmdldExvY2FsU3RvcmFnZSgpLnNldE9iamVjdCgncmVjZW50UXVlcmllcycsIHF1ZXJpZXMpO1xuICBlbnZpcm9ubWVudC5nZXRMb2NhbFN0b3JhZ2UoKS5zZXRPYmplY3QoJ2Zhdm9yaXRlUXVlcmllcycsIGZhdm9yaXRlUXVlcmllcyk7XG4gIGVudmlyb25tZW50LmdldExvY2FsU3RvcmFnZSgpLnNldEl0ZW0oJ2lzRmF2b3JpdGVzUmVmYWN0b3JlZCcsIHRydWUpO1xufVxuXG5cbnZhciBIaXN0b3J5ID0ge1xuICBpbml0LFxuICB1cGRhdGUsXG4gIHNob3dIaXN0b3J5LFxuICBzaG93RmF2b3JpdGVzLFxuICBjbGVhckhpc3RvcnksXG4gIGNsZWFyRmF2b3JpdGVzLFxuICBkaXNwbGF5RGF0YSxcbiAgc2VuZFNob3dUZWxlbWV0cnksXG4gIHNob3dPbmx5RmF2b3JpdGU6IGZhbHNlXG59O1xuXG5leHBvcnQgZGVmYXVsdCBIaXN0b3J5O1xuIl19