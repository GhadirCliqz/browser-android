System.register('mobile-freshtab/news', ['mobile-touch/longpress'], function (_export) {
  /* global CustomEvent, window, document, CLIQZEnvironment, CliqzLanguage, CliqzUtils, CliqzHandlebars, osAPI */

  'use strict';

  var LongPress, DEPENDENCY_STATUS, topSitesList, tempBlockedTopSites, newsVersion, displayedTopSitesCount, TOPSITES_LIMIT, News;

  function displayTopSites(list) {
    var isEditMode = arguments.length <= 1 || arguments[1] === undefined ? false : arguments[1];

    var blockedTopSites = CLIQZEnvironment.getLocalStorage().getObject('blockedTopSites', []);

    list = deduplicateTopsites(list);

    list = list.filter(function (item) {
      return blockedTopSites.indexOf(item.mainDomain) === -1;
    });

    list = list.filter(function (item) {
      return tempBlockedTopSites.indexOf(item.mainDomain) === -1;
    });

    displayedTopSitesCount = Math.min(list.length, TOPSITES_LIMIT);

    list = list.map(function (r) {
      var details = CliqzUtils.getDetailsFromUrl(r.url);
      var logo = CliqzUtils.getLogoDetails(details);
      return {
        title: r.title,
        displayUrl: details.domain || r.title,
        url: r.url,
        text: logo.text,
        backgroundColor: logo.backgroundColor,
        buttonsClass: logo.buttonsClass,
        style: logo.style,
        mainDomain: r.mainDomain,
        baseDomain: r.url.match(/^(?:https?:\/\/)?(?:www\.)?([^\/]+)/i)[0],
        domain: r.url.match(/^(?:https?:\/\/)?(?:www\.)?([^\/]+)/i)[1]
      };
    });

    var isEmpty = list.length ? false : true;

    list = list.concat(Array(TOPSITES_LIMIT).fill(''));
    list = list.splice(0, TOPSITES_LIMIT);

    var topSites = CliqzHandlebars.tplCache.topsites;
    var div = document.getElementById('topSites');
    div.innerHTML = topSites({ isEmpty: isEmpty, isEditMode: isEditMode, list: list });

    CLIQZEnvironment.addEventListenerToElements('#doneEditTopsites', 'click', function (_) {
      var blockedTopSites = CLIQZEnvironment.getLocalStorage().getObject('blockedTopSites', []);
      CLIQZEnvironment.getLocalStorage().setObject('blockedTopSites', blockedTopSites.concat(tempBlockedTopSites));
      tempBlockedTopSites = [];
      displayTopSites(topSitesList);
    });

    CLIQZEnvironment.addEventListenerToElements('#cancelEditTopsites', 'click', function (_) {
      tempBlockedTopSites = [];
      displayTopSites(topSitesList);
    });

    CLIQZEnvironment.addEventListenerToElements('.blockTopsite', 'click', function () {
      tempBlockedTopSites.push(this.getAttribute('mainDomain'));
      displayTopSites(topSitesList, true);
    });

    function onLongpress() {
      displayTopSites(topSitesList, true);
    }

    function onTap(element) {
      osAPI.openLink(element.getAttribute('url'));
      CliqzUtils.telemetry({
        type: 'home',
        action: 'click',
        target_type: 'topsites',
        target_index: element.dataset.index
      });
    }

    new LongPress('.topSitesLink', onLongpress, onTap);
  }

  function deduplicateTopsites(list) {
    var domains = {};
    return list.filter(function (item) {
      return !domains[item.mainDomain] && (domains[item.mainDomain] = true);
    });
  }

  function log() {
    CliqzUtils.log(arguments, 'News');
  }
  return {
    setters: [function (_mobileTouchLongpress) {
      LongPress = _mobileTouchLongpress['default'];
    }],
    execute: function () {
      DEPENDENCY_STATUS = {
        NOT_LOADED: 'NOT_LOADED',
        LOADED: 'LOADED',
        GIVE_UP: 'GIVE_UP',
        RETRY_LIMIT: 20,
        retryCount: {}
      };
      topSitesList = [];
      tempBlockedTopSites = [];
      TOPSITES_LIMIT = 5;
      News = {
        GENERIC_NEWS_URL: 'https://newbeta.cliqz.com/api/v1/rich-header?path=/map&bmresult=rotated-top-news.cliqz.com&lang=de,en&locale=de',
        _recentHistory: {},
        getNews: function getNews() {
          log('loading news');

          var method = 'GET',
              callback = function callback(data) {
            try {
              var sResponse = JSON.parse(data.responseText);
              newsVersion = sResponse.results[0].news_version;
              News.displayTopNews(sResponse.results[0].articles);
            } catch (e) {
              log(e);
            }
          },
              onerror = function onerror() {
            log('news error', arguments);
            setTimeout(News.getNews, 1500);
          },
              timeout = function timeout() {
            log('timeout error', arguments);
            News.getNews();
          },
              data = null,
              asynchronous = true;
          CLIQZEnvironment.httpHandler(method, News.GENERIC_NEWS_URL, callback, onerror, timeout, data, asynchronous);
        },
        displayTopNews: function displayTopNews(top_news) {
          if (!top_news) {
            return;
          }

          top_news = top_news.map(function (r) {
            var details = CliqzUtils.getDetailsFromUrl(r.url);
            var logo = CliqzUtils.getLogoDetails(details);
            return {
              title: r.title,
              description: r.description,
              short_title: r.short_title || r.title,
              displayUrl: details.domain || r.title,
              url: r.url,
              type: r.type,
              text: logo.text,
              backgroundColor: logo.backgroundColor,
              buttonsClass: logo.buttonsClass,
              style: logo.style
            };
          });
          top_news = top_news.splice(0, 2);
          var dependencyStatus = News.getDependencyStatus('topnews');
          if (dependencyStatus === DEPENDENCY_STATUS.NOT_LOADED) {
            return setTimeout(News.displayTopNews, 100, top_news);
          } else if (dependencyStatus === DEPENDENCY_STATUS.GIVE_UP) {
            return;
          }
          var topNews = CliqzHandlebars.tplCache.topnews;
          var div = document.getElementById('topNews');
          div.innerHTML = topNews(top_news);
          CLIQZEnvironment.addEventListenerToElements('.topNewsLink', 'click', function () {
            CliqzUtils.telemetry({
              type: 'home',
              action: 'click',
              target_type: 'topnews',
              target_index: this.dataset.index
            });
          });
          window.dispatchEvent(new CustomEvent('newsLoadingDone'));

          CliqzUtils.telemetry({
            'type': 'home',
            'action': 'display',
            'historysites': displayedTopSitesCount,
            'topnews_version': newsVersion
          });
        },

        getRecentHistory: function getRecentHistory(history) {
          history.results.forEach(function (result) {
            return News._recentHistory[result.url] = true;
          });
        },
        startPageHandler: function startPageHandler(list) {
          var dependencyStatus = News.getDependencyStatus('topsites');
          if (dependencyStatus === DEPENDENCY_STATUS.NOT_LOADED) {
            return setTimeout(News.startPageHandler, 100, list);
          } else if (dependencyStatus === DEPENDENCY_STATUS.GIVE_UP) {
            return;
          }

          News.getNews();

          topSitesList = [];
          var domain = undefined,
              domainArr = undefined,
              mainDomain = undefined;
          for (var i = 0; i < list.length; i++) {
            domain = list[i].url.match(/^(?:https?:\/\/)?(?:www\.)?([^\/]+)/i)[1];
            domainArr = domain.split('.');
            mainDomain = domainArr[domainArr.length - 2].substr(0, 10);
            mainDomain = mainDomain.charAt(0).toUpperCase() + mainDomain.slice(1);
            list[i].mainDomain = mainDomain;
            topSitesList.push(list[i]);
          }

          displayTopSites(topSitesList);
        },
        // wait for logos, templates, and locale to be loaded
        getDependencyStatus: function getDependencyStatus(template) {
          if (DEPENDENCY_STATUS.retryCount[template] === undefined) {
            DEPENDENCY_STATUS.retryCount[template] = 0;
          }
          if (!CliqzUtils.BRANDS_DATABASE.buttons || !CliqzHandlebars.tplCache[template]) {
            return DEPENDENCY_STATUS.retryCount[template]++ < DEPENDENCY_STATUS.RETRY_LIMIT ? DEPENDENCY_STATUS.NOT_LOADED : DEPENDENCY_STATUS.GIVE_UP;
          }
          DEPENDENCY_STATUS.retryCount[template] = 0;
          return DEPENDENCY_STATUS.LOADED;
        }
      };

      _export('default', News);
    }
  };
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm1vYmlsZS1mcmVzaHRhYi9uZXdzLmVzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O2lCQUlJLGlCQUFpQixFQVFqQixZQUFZLEVBQU8sbUJBQW1CLEVBQU8sV0FBVyxFQUFFLHNCQUFzQixFQUFFLGNBQWMsRUFpRmhHLElBQUk7O0FBL0VSLFdBQVMsZUFBZSxDQUFFLElBQUksRUFBc0I7UUFBcEIsVUFBVSx5REFBRyxLQUFLOztBQUVoRCxRQUFNLGVBQWUsR0FBRyxnQkFBZ0IsQ0FBQyxlQUFlLEVBQUUsQ0FBQyxTQUFTLENBQUMsaUJBQWlCLEVBQUUsRUFBRSxDQUFDLENBQUM7O0FBRTVGLFFBQUksR0FBRyxtQkFBbUIsQ0FBQyxJQUFJLENBQUMsQ0FBQzs7QUFFakMsUUFBSSxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUMsVUFBQSxJQUFJO2FBQUksZUFBZSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLEtBQUssQ0FBQyxDQUFDO0tBQUEsQ0FBQyxDQUFDOztBQUU1RSxRQUFJLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxVQUFBLElBQUk7YUFBSSxtQkFBbUIsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxLQUFLLENBQUMsQ0FBQztLQUFBLENBQUMsQ0FBQzs7QUFFaEYsMEJBQXNCLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsTUFBTSxFQUFFLGNBQWMsQ0FBQyxDQUFDOztBQUUvRCxRQUFJLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxVQUFVLENBQUMsRUFBRTtBQUMzQixVQUFNLE9BQU8sR0FBRyxVQUFVLENBQUMsaUJBQWlCLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDO0FBQ3BELFVBQU0sSUFBSSxHQUFHLFVBQVUsQ0FBQyxjQUFjLENBQUMsT0FBTyxDQUFDLENBQUM7QUFDaEQsYUFBTztBQUNMLGFBQUssRUFBRSxDQUFDLENBQUMsS0FBSztBQUNkLGtCQUFVLEVBQUUsT0FB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aUJBQWlCLENBQUMsTUFBTSxDQUFDO1NBQ2pDO09BQ0Y7O3lCQUtjLElBQUkiLCJmaWxlIjoibW9iaWxlLWZyZXNodGFiL25ld3MuZXMiLCJzb3VyY2VzQ29udGVudCI6WyIvKiBnbG9iYWwgQ3VzdG9tRXZlbnQsIHdpbmRvdywgZG9jdW1lbnQsIENMSVFaRW52aXJvbm1lbnQsIENsaXF6TGFuZ3VhZ2UsIENsaXF6VXRpbHMsIENsaXF6SGFuZGxlYmFycywgb3NBUEkgKi9cblxuaW1wb3J0IExvbmdQcmVzcyBmcm9tICdtb2JpbGUtdG91Y2gvbG9uZ3ByZXNzJztcblxudmFyIERFUEVOREVOQ1lfU1RBVFVTID0ge1xuICBOT1RfTE9BREVEOiAnTk9UX0xPQURFRCcsXG4gIExPQURFRDogJ0xPQURFRCcsXG4gIEdJVkVfVVA6ICdHSVZFX1VQJyxcbiAgUkVUUllfTElNSVQ6IDIwLFxuICByZXRyeUNvdW50OiB7fVxufTtcblxudmFyIHRvcFNpdGVzTGlzdCA9IFtdLCB0ZW1wQmxvY2tlZFRvcFNpdGVzID0gW10sIG5ld3NWZXJzaW9uLCBkaXNwbGF5ZWRUb3BTaXRlc0NvdW50LCBUT1BTSVRFU19MSU1JVCA9IDU7XG5cbmZ1bmN0aW9uIGRpc3BsYXlUb3BTaXRlcyAobGlzdCwgaXNFZGl0TW9kZSA9IGZhbHNlKSB7XG5cbiAgY29uc3QgYmxvY2tlZFRvcFNpdGVzID0gQ0xJUVpFbnZpcm9ubWVudC5nZXRMb2NhbFN0b3JhZ2UoKS5nZXRPYmplY3QoJ2Jsb2NrZWRUb3BTaXRlcycsIFtdKTtcblxuICBsaXN0ID0gZGVkdXBsaWNhdGVUb3BzaXRlcyhsaXN0KTtcblxuICBsaXN0ID0gbGlzdC5maWx0ZXIoaXRlbSA9PiBibG9ja2VkVG9wU2l0ZXMuaW5kZXhPZihpdGVtLm1haW5Eb21haW4pID09PSAtMSk7XG5cbiAgbGlzdCA9IGxpc3QuZmlsdGVyKGl0ZW0gPT4gdGVtcEJsb2NrZWRUb3BTaXRlcy5pbmRleE9mKGl0ZW0ubWFpbkRvbWFpbikgPT09IC0xKTtcblxuICBkaXNwbGF5ZWRUb3BTaXRlc0NvdW50ID0gTWF0aC5taW4obGlzdC5sZW5ndGgsIFRPUFNJVEVTX0xJTUlUKTtcblxuICBsaXN0ID0gbGlzdC5tYXAoZnVuY3Rpb24gKHIpIHtcbiAgICBjb25zdCBkZXRhaWxzID0gQ2xpcXpVdGlscy5nZXREZXRhaWxzRnJvbVVybChyLnVybCk7XG4gICAgY29uc3QgbG9nbyA9IENsaXF6VXRpbHMuZ2V0TG9nb0RldGFpbHMoZGV0YWlscyk7XG4gICAgcmV0dXJuIHtcbiAgICAgIHRpdGxlOiByLnRpdGxlLFxuICAgICAgZGlzcGxheVVybDogZGV0YWlscy5kb21haW4gfHwgci50aXRsZSxcbiAgICAgIHVybDogci51cmwsXG4gICAgICB0ZXh0OiBsb2dvLnRleHQsXG4gICAgICBiYWNrZ3JvdW5kQ29sb3I6IGxvZ28uYmFja2dyb3VuZENvbG9yLFxuICAgICAgYnV0dG9uc0NsYXNzOiBsb2dvLmJ1dHRvbnNDbGFzcyxcbiAgICAgIHN0eWxlOiBsb2dvLnN0eWxlLFxuICAgICAgbWFpbkRvbWFpbjogci5tYWluRG9tYWluLFxuICAgICAgYmFzZURvbWFpbjogci51cmwubWF0Y2goL14oPzpodHRwcz86XFwvXFwvKT8oPzp3d3dcXC4pPyhbXlxcL10rKS9pKVswXSxcbiAgICAgIGRvbWFpbjogci51cmwubWF0Y2goL14oPzpodHRwcz86XFwvXFwvKT8oPzp3d3dcXC4pPyhbXlxcL10rKS9pKVsxXVxuICAgIH07XG4gIH0pO1xuICBcbiAgY29uc3QgaXNFbXB0eSA9IGxpc3QubGVuZ3RoID8gZmFsc2UgOiB0cnVlO1xuXG4gIGxpc3QgPSBsaXN0LmNvbmNhdChBcnJheShUT1BTSVRFU19MSU1JVCkuZmlsbCgnJykpO1xuICBsaXN0ID0gbGlzdC5zcGxpY2UoMCwgVE9QU0lURVNfTElNSVQpO1xuXG4gIGNvbnN0IHRvcFNpdGVzID0gQ2xpcXpIYW5kbGViYXJzLnRwbENhY2hlLnRvcHNpdGVzO1xuICBjb25zdCBkaXYgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgndG9wU2l0ZXMnKTtcbiAgZGl2LmlubmVySFRNTCA9IHRvcFNpdGVzKHtpc0VtcHR5LCBpc0VkaXRNb2RlLCBsaXN0fSk7XG5cblxuICBDTElRWkVudmlyb25tZW50LmFkZEV2ZW50TGlzdGVuZXJUb0VsZW1lbnRzKCcjZG9uZUVkaXRUb3BzaXRlcycsICdjbGljaycsIF8gPT4ge1xuICAgIGNvbnN0IGJsb2NrZWRUb3BTaXRlcyA9IENMSVFaRW52aXJvbm1lbnQuZ2V0TG9jYWxTdG9yYWdlKCkuZ2V0T2JqZWN0KCdibG9ja2VkVG9wU2l0ZXMnLCBbXSk7XG4gICAgQ0xJUVpFbnZpcm9ubWVudC5nZXRMb2NhbFN0b3JhZ2UoKS5zZXRPYmplY3QoJ2Jsb2NrZWRUb3BTaXRlcycsIGJsb2NrZWRUb3BTaXRlcy5jb25jYXQodGVtcEJsb2NrZWRUb3BTaXRlcykpO1xuICAgIHRlbXBCbG9ja2VkVG9wU2l0ZXMgPSBbXTtcbiAgICBkaXNwbGF5VG9wU2l0ZXModG9wU2l0ZXNMaXN0KTtcbiAgfSk7XG5cbiAgQ0xJUVpFbnZpcm9ubWVudC5hZGRFdmVudExpc3RlbmVyVG9FbGVtZW50cygnI2NhbmNlbEVkaXRUb3BzaXRlcycsICdjbGljaycsIF8gPT4ge1xuICAgIHRlbXBCbG9ja2VkVG9wU2l0ZXMgPSBbXTtcbiAgICBkaXNwbGF5VG9wU2l0ZXModG9wU2l0ZXNMaXN0KTtcbiAgfSk7XG5cbiAgQ0xJUVpFbnZpcm9ubWVudC5hZGRFdmVudExpc3RlbmVyVG9FbGVtZW50cygnLmJsb2NrVG9wc2l0ZScsICdjbGljaycsIGZ1bmN0aW9uICgpIHtcbiAgICB0ZW1wQmxvY2tlZFRvcFNpdGVzLnB1c2godGhpcy5nZXRBdHRyaWJ1dGUoJ21haW5Eb21haW4nKSk7XG4gICAgZGlzcGxheVRvcFNpdGVzKHRvcFNpdGVzTGlzdCwgdHJ1ZSk7XG4gIH0pO1xuXG4gIGZ1bmN0aW9uIG9uTG9uZ3ByZXNzICgpIHtcbiAgICBkaXNwbGF5VG9wU2l0ZXModG9wU2l0ZXNMaXN0LCB0cnVlKTtcbiAgfVxuXG4gIGZ1bmN0aW9uIG9uVGFwIChlbGVtZW50KSB7XG4gICAgb3NBUEkub3BlbkxpbmsoZWxlbWVudC5nZXRBdHRyaWJ1dGUoJ3VybCcpKTtcbiAgICBDbGlxelV0aWxzLnRlbGVtZXRyeSh7XG4gICAgICB0eXBlOiAnaG9tZScsXG4gICAgICBhY3Rpb246ICdjbGljaycsXG4gICAgICB0YXJnZXRfdHlwZTogJ3RvcHNpdGVzJyxcbiAgICAgIHRhcmdldF9pbmRleDogZWxlbWVudC5kYXRhc2V0LmluZGV4XG4gICAgfSk7XG4gIH1cblxuICBuZXcgTG9uZ1ByZXNzKCcudG9wU2l0ZXNMaW5rJywgb25Mb25ncHJlc3MsIG9uVGFwKTtcblxufVxuXG5mdW5jdGlvbiBkZWR1cGxpY2F0ZVRvcHNpdGVzKGxpc3QpIHtcbiAgbGV0IGRvbWFpbnMgPSB7fTtcbiAgcmV0dXJuIGxpc3QuZmlsdGVyKGl0ZW0gPT4gIWRvbWFpbnNbaXRlbS5tYWluRG9tYWluXSAmJiAoZG9tYWluc1tpdGVtLm1haW5Eb21haW5dID0gdHJ1ZSkpO1xufVxuXG52YXIgTmV3cyA9IHtcbiAgR0VORVJJQ19ORVdTX1VSTDogJ2h0dHBzOi8vbmV3YmV0YS5jbGlxei5jb20vYXBpL3YxL3JpY2gtaGVhZGVyP3BhdGg9L21hcCZibXJlc3VsdD1yb3RhdGVkLXRvcC1uZXdzLmNsaXF6LmNvbSZsYW5nPWRlLGVuJmxvY2FsZT1kZScsXG4gIF9yZWNlbnRIaXN0b3J5OiB7fSxcbiAgZ2V0TmV3czogZnVuY3Rpb24oKSB7XG4gICAgbG9nKCdsb2FkaW5nIG5ld3MnKTtcblxuICAgIGxldCBtZXRob2QgPSAnR0VUJyxcbiAgICBjYWxsYmFjayA9IGZ1bmN0aW9uKGRhdGEpIHtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGNvbnN0IHNSZXNwb25zZSA9IEpTT04ucGFyc2UoZGF0YS5yZXNwb25zZVRleHQpO1xuICAgICAgICAgICAgbmV3c1ZlcnNpb24gPSBzUmVzcG9uc2UucmVzdWx0c1swXS5uZXdzX3ZlcnNpb247XG4gICAgICAgICAgICBOZXdzLmRpc3BsYXlUb3BOZXdzKHNSZXNwb25zZS5yZXN1bHRzWzBdLmFydGljbGVzKTtcbiAgICAgICAgfSBjYXRjaChlKSB7XG4gICAgICAgICAgICBsb2coZSk7XG4gICAgICAgIH1cbiAgICB9LFxuICAgIG9uZXJyb3IgPSBmdW5jdGlvbigpIHtcbiAgICAgIGxvZygnbmV3cyBlcnJvcicsIGFyZ3VtZW50cyk7XG4gICAgICBzZXRUaW1lb3V0KE5ld3MuZ2V0TmV3cywgMTUwMCk7XG4gICAgfSxcbiAgICB0aW1lb3V0ID0gZnVuY3Rpb24oKSB7XG4gICAgICBsb2coJ3RpbWVvdXQgZXJyb3InLCBhcmd1bWVudHMpO1xuICAgICAgTmV3cy5nZXROZXdzKCk7XG4gICAgfSxcbiAgICBkYXRhID0gbnVsbCxcbiAgICBhc3luY2hyb25vdXMgPSB0cnVlO1xuICAgIENMSVFaRW52aXJvbm1lbnQuaHR0cEhhbmRsZXIobWV0aG9kLCBOZXdzLkdFTkVSSUNfTkVXU19VUkwsIGNhbGxiYWNrLCBvbmVycm9yLCB0aW1lb3V0LCBkYXRhLCBhc3luY2hyb25vdXMpO1xuXG4gIH0sXG4gIGRpc3BsYXlUb3BOZXdzOiBmdW5jdGlvbih0b3BfbmV3cykge1xuICAgIGlmKCF0b3BfbmV3cykge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIHRvcF9uZXdzID0gdG9wX25ld3MubWFwKGZ1bmN0aW9uKHIpe1xuICAgICAgY29uc3QgZGV0YWlscyA9IENsaXF6VXRpbHMuZ2V0RGV0YWlsc0Zyb21Vcmwoci51cmwpO1xuICAgICAgY29uc3QgbG9nbyA9IENsaXF6VXRpbHMuZ2V0TG9nb0RldGFpbHMoZGV0YWlscyk7XG4gICAgICByZXR1cm4ge1xuICAgICAgICB0aXRsZTogci50aXRsZSxcbiAgICAgICAgZGVzY3JpcHRpb246IHIuZGVzY3JpcHRpb24sXG4gICAgICAgIHNob3J0X3RpdGxlOiByLnNob3J0X3RpdGxlIHx8IHIudGl0bGUsXG4gICAgICAgIGRpc3BsYXlVcmw6IGRldGFpbHMuZG9tYWluIHx8IHIudGl0bGUsXG4gICAgICAgIHVybDogci51cmwsXG4gICAgICAgIHR5cGU6IHIudHlwZSxcbiAgICAgICAgdGV4dDogbG9nby50ZXh0LFxuICAgICAgICBiYWNrZ3JvdW5kQ29sb3I6IGxvZ28uYmFja2dyb3VuZENvbG9yLFxuICAgICAgICBidXR0b25zQ2xhc3M6IGxvZ28uYnV0dG9uc0NsYXNzLFxuICAgICAgICBzdHlsZTogbG9nby5zdHlsZVxuICAgICAgfTtcbiAgICB9KTtcbiAgICB0b3BfbmV3cyA9IHRvcF9uZXdzLnNwbGljZSgwLCAyKTtcbiAgICBjb25zdCBkZXBlbmRlbmN5U3RhdHVzID0gTmV3cy5nZXREZXBlbmRlbmN5U3RhdHVzKCd0b3BuZXdzJyk7XG4gICAgaWYoZGVwZW5kZW5jeVN0YXR1cyA9PT0gREVQRU5ERU5DWV9TVEFUVVMuTk9UX0xPQURFRCkge1xuICAgICAgcmV0dXJuIHNldFRpbWVvdXQoTmV3cy5kaXNwbGF5VG9wTmV3cywgMTAwLCB0b3BfbmV3cyk7XG4gICAgfSBlbHNlIGlmKGRlcGVuZGVuY3lTdGF0dXMgPT09IERFUEVOREVOQ1lfU1RBVFVTLkdJVkVfVVApIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgY29uc3QgdG9wTmV3cyA9IENsaXF6SGFuZGxlYmFycy50cGxDYWNoZS50b3BuZXdzO1xuICAgIGNvbnN0IGRpdiA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd0b3BOZXdzJyk7XG4gICAgZGl2LmlubmVySFRNTCA9IHRvcE5ld3ModG9wX25ld3MpO1xuICAgIENMSVFaRW52aXJvbm1lbnQuYWRkRXZlbnRMaXN0ZW5lclRvRWxlbWVudHMoJy50b3BOZXdzTGluaycsICdjbGljaycsIGZ1bmN0aW9uICgpIHtcbiAgICAgIENsaXF6VXRpbHMudGVsZW1ldHJ5KHtcbiAgICAgICAgdHlwZTogJ2hvbWUnLFxuICAgICAgICBhY3Rpb246ICdjbGljaycsXG4gICAgICAgIHRhcmdldF90eXBlOiAndG9wbmV3cycsXG4gICAgICAgIHRhcmdldF9pbmRleDogdGhpcy5kYXRhc2V0LmluZGV4XG4gICAgICB9KTtcbiAgICB9KTtcbiAgICB3aW5kb3cuZGlzcGF0Y2hFdmVudChuZXcgQ3VzdG9tRXZlbnQoJ25ld3NMb2FkaW5nRG9uZScpKTtcblxuICAgIENsaXF6VXRpbHMudGVsZW1ldHJ5KHtcbiAgICAgICd0eXBlJzogJ2hvbWUnLFxuICAgICAgJ2FjdGlvbic6ICdkaXNwbGF5JyxcbiAgICAgICdoaXN0b3J5c2l0ZXMnOiBkaXNwbGF5ZWRUb3BTaXRlc0NvdW50LFxuICAgICAgJ3RvcG5ld3NfdmVyc2lvbic6IG5ld3NWZXJzaW9uXG4gICAgfSk7XG4gIH0sXG5cbiAgZ2V0UmVjZW50SGlzdG9yeTogZnVuY3Rpb24gKGhpc3RvcnkpIHtcbiAgICBoaXN0b3J5LnJlc3VsdHMuZm9yRWFjaChyZXN1bHQgPT4gTmV3cy5fcmVjZW50SGlzdG9yeVtyZXN1bHQudXJsXSA9IHRydWUpO1xuICB9LFxuICBzdGFydFBhZ2VIYW5kbGVyOiBmdW5jdGlvbiAobGlzdCkge1xuICAgIGNvbnN0IGRlcGVuZGVuY3lTdGF0dXMgPSBOZXdzLmdldERlcGVuZGVuY3lTdGF0dXMoJ3RvcHNpdGVzJyk7XG4gICAgaWYoZGVwZW5kZW5jeVN0YXR1cyA9PT0gREVQRU5ERU5DWV9TVEFUVVMuTk9UX0xPQURFRCkge1xuICAgICAgcmV0dXJuIHNldFRpbWVvdXQoTmV3cy5zdGFydFBhZ2VIYW5kbGVyLCAxMDAsIGxpc3QpO1xuICAgIH0gZWxzZSBpZihkZXBlbmRlbmN5U3RhdHVzID09PSBERVBFTkRFTkNZX1NUQVRVUy5HSVZFX1VQKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgTmV3cy5nZXROZXdzKCk7XG5cbiAgICB0b3BTaXRlc0xpc3QgPSBbXTtcbiAgICBsZXQgZG9tYWluLCBkb21haW5BcnIsIG1haW5Eb21haW47XG4gICAgZm9yKHZhciBpPTA7IGk8bGlzdC5sZW5ndGg7IGkrKykge1xuICAgICAgZG9tYWluID0gbGlzdFtpXS51cmwubWF0Y2goL14oPzpodHRwcz86XFwvXFwvKT8oPzp3d3dcXC4pPyhbXlxcL10rKS9pKVsxXTtcbiAgICAgIGRvbWFpbkFyciA9IGRvbWFpbi5zcGxpdCgnLicpO1xuICAgICAgbWFpbkRvbWFpbiA9IGRvbWFpbkFycltkb21haW5BcnIubGVuZ3RoLTJdLnN1YnN0cigwLCAxMCk7XG4gICAgICBtYWluRG9tYWluID0gbWFpbkRvbWFpbi5jaGFyQXQoMCkudG9VcHBlckNhc2UoKSArIG1haW5Eb21haW4uc2xpY2UoMSk7XG4gICAgICBsaXN0W2ldLm1haW5Eb21haW4gPSBtYWluRG9tYWluO1xuICAgICAgdG9wU2l0ZXNMaXN0LnB1c2gobGlzdFtpXSk7XG4gICAgfVxuXG4gICAgZGlzcGxheVRvcFNpdGVzKHRvcFNpdGVzTGlzdCk7XG4gIH0sXG4gIC8vIHdhaXQgZm9yIGxvZ29zLCB0ZW1wbGF0ZXMsIGFuZCBsb2NhbGUgdG8gYmUgbG9hZGVkXG4gIGdldERlcGVuZGVuY3lTdGF0dXM6IGZ1bmN0aW9uKHRlbXBsYXRlKSB7XG4gICAgaWYoREVQRU5ERU5DWV9TVEFUVVMucmV0cnlDb3VudFt0ZW1wbGF0ZV0gPT09IHVuZGVmaW5lZCkge1xuICAgICAgREVQRU5ERU5DWV9TVEFUVVMucmV0cnlDb3VudFt0ZW1wbGF0ZV0gPSAwO1xuICAgIH1cbiAgICBpZighQ2xpcXpVdGlscy5CUkFORFNfREFUQUJBU0UuYnV0dG9ucyB8fCAhQ2xpcXpIYW5kbGViYXJzLnRwbENhY2hlW3RlbXBsYXRlXSkge1xuICAgICAgcmV0dXJuIERFUEVOREVOQ1lfU1RBVFVTLnJldHJ5Q291bnRbdGVtcGxhdGVdKysgPCBERVBFTkRFTkNZX1NUQVRVUy5SRVRSWV9MSU1JVCA/IERFUEVOREVOQ1lfU1RBVFVTLk5PVF9MT0FERUQgOiBERVBFTkRFTkNZX1NUQVRVUy5HSVZFX1VQO1xuICAgIH1cbiAgICBERVBFTkRFTkNZX1NUQVRVUy5yZXRyeUNvdW50W3RlbXBsYXRlXSA9IDA7XG4gICAgcmV0dXJuIERFUEVOREVOQ1lfU1RBVFVTLkxPQURFRDtcbiAgfVxufTtcblxuZnVuY3Rpb24gbG9nKCkge1xuICBDbGlxelV0aWxzLmxvZyhhcmd1bWVudHMsICdOZXdzJyk7XG59XG5leHBvcnQgZGVmYXVsdCBOZXdzO1xuIl19